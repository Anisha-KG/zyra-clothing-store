<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Orders</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        .pagination .page-item.active .page-link {
            background-color: #912f2f;
            border-color: #912f2f;
            color: white;
        }
        .pagination .page-link:hover {
            background-color: #912f2f;
            color: white;
        }
        .table-head th {
            background-color: #dbcfc5 !important;
            color: #0e0d0d !important;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <%- include("../../views/partials/admin/header") %>

    <main class="col-12 col-md-10 px-3 pt-3">
        <div class="d-flex justify-content-between align-items-center my-3">
            <h4><strong>Orders</strong></h4>
<form class="d-flex gap-2" onsubmit="event.preventDefault(); loadData(1);">
                <!-- SEARCH -->
                <input 
                    type="text" 
                    name="search" 
                    id="search"
                    value="<%= search || '' %>" 
                    placeholder="Search order..." 
                    class="form-control" 
                    style="width: 250px;" 
                    autocomplete="off">

                <button class="btn btn-dark btn-sm" type="submit">Search</button>

                <!-- SORT DROPDOWN -->
                <select name="sort" id="sort" class="form-select form-select-sm" style="width:150px;">
                    <option value="">Sort By</option>
                    <option value="newest" <%= sort === "newest" ? "selected" : "" %>>Newest</option>
                    <option value="oldest" <%= sort === "oldest" ? "selected" : "" %>>Oldest</option>
                </select>

                <!-- PAYMENT FILTER -->
                <select name="paymentStatus" id="filter" class="form-select form-select-sm" style="width:160px;">
                    <option value="">Payment Filter</option>
                    <option value="Pending" <%= paymentStatus === "Pending" ? "selected" : "" %>>Pending</option>
                    <option value="Completed" <%= paymentStatus === "Completed" ? "selected" : "" %>>Completed</option>
                    <option value="Failed" <%= paymentStatus === "Failed" ? "selected" : "" %>>Failed</option>
                    <option value="Refunded" <%= paymentStatus === "Refunded" ? "selected" : "" %>>Refunded</option>
                </select>

                <button 
                    type="button" 
                    class="btn btn-outline-danger btn-sm"
                    onclick="clearFilters()">
                    Clear
                </button>
            </form>
        </div>

        <!-- TABLE -->
        <div class="table-responsive bg-white p-3 rounded shadow-sm">
            <table class="table align-middle table-hover">
                <thead class="table-head">
                    <tr>
                        <th>Sl No</th>
                        <th>Order ID</th>
                        <th>Order Date</th>
                        <th>User Email</th>
                        <th>Total Amount</th>
                        <th>Payment Method</th>
                        <th>Payment Status</th>
                        <th>Order concern</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>

                    <% if (orders && orders.length > 0) { %>

                        <% orders.forEach((order, index) => { %>
                        <tr>
                            <td><%= ((currentPage - 1) * limit) + index + 1 %></td>
                            <td><%= order.orderId %></td>
                            <td><%= order.createdAt.toISOString().split('T')[0] %></td>
                            <td><%= order.userId.email %></td>
                            <td>â‚¹<%= order.totalPayable %></td>
                            <td><%= order.paymentMethod %></td>

                            <td>
                                <span class="badge bg-warning"><%= order.paymentStatus %></span>
                            </td>

                            <td>
                                <% order.orderedItems.forEach((item, idx) => { %>
                                    <%= item.cancellationRequest?.reason || '-' %><%= idx < order.orderedItems.length - 1 ? ', ' : '' %>
                                <% }) %>
                            </td>

                            <td>
                                <button class="btn btn-sm btn-primary"
                                    onclick="window.location.href='/admin/orders/<%= order.orderId%>'">View</button>
                            </td>
                        </tr>
                        <% }) %>

                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center text-muted">No orders found</td>
                        </tr>
                    <% } %>

                </tbody>
            </table>

            <div class="d-flex justify-content-center mt-4">
    <nav>
        <ul class="pagination pagination-sm justify-content-center">

            <!-- Previous -->
            <li class="page-item">
                <button 
                    class="page-link"
                    onclick="loadData(<%= currentPage - 1 %>)"
                    <%= currentPage === 1 ? "disabled" : "" %>>
                    Previous
                </button>
            </li>

            <!-- Page Numbers -->
            <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                <button 
                    class="page-link" 
                    onclick="loadData(<%= i %>)">
                    <%= i %>
                </button>
            </li>
            <% } %>

            <!-- Next -->
            <li class="page-item">
                <button 
                    class="page-link" 
                    onclick="loadData(<%= currentPage + 1 %>)"
                    <%= currentPage === totalPages ? "disabled" : "" %>>
                    Next
                </button>
            </li>

        </ul>
    </nav>
</div>



        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function loadData(page = 1) {
    const sort = document.getElementById('sort').value;
    const filter = document.getElementById('filter').value;
    const search = document.getElementById('search').value.trim();

    const url = `/admin/orders?search=${search}&sort=${sort}&paymentStatus=${filter}&page=${page}`;
    window.location.href = url;
}

document.getElementById('sort').addEventListener('change', (e) => {
    e.preventDefault();
    loadData(1);
});

document.getElementById('filter').addEventListener('change', (e) => {
    e.preventDefault();
    loadData(1);
});

document.getElementById('search').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        loadData(1);
    }
});

function clearFilters() {
    document.getElementById('search').value = "";
    document.getElementById('sort').value = "";
    document.getElementById('filter').value = "";
    loadData(1);
}

    </script>
</body>
</html>
