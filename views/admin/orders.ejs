<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Orders</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Pagination */
        .pagination .page-item.active .page-link {
            background-color: #912f2f;
            border-color: #912f2f;
            color: white;
        }
        .pagination .page-link:hover {
            background-color: #912f2f;
            color: white;
        }

        /* Table header */
        .table-head th {
            background-color: #dbcfc5 !important;
            color: #0e0d0d !important;
        }

        /* Filter Card */
        .filter-card {
            background: #ffffff;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .btn-style{
            background-color: #912f2f !important;
            color: white !important;
        }

.btn-grey {
  background-color: #6c757d !important;   /* Bootstrap grey */
  color: #ffffff !important;
  border: none;
}

.btn-grey:hover {
  background-color: #5a6268 !important;   /* Darker grey on hover */
  color: #ffffff !important;
}

        /* Small screen adjustments */
        @media (max-width: 768px) {
            .page-header {
                text-align: center;
            }

            .filter-card {
                text-align: center;
            }

            .filter-card input,
            .filter-card select,
            .filter-card button {
                width: 100% !important;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

<%- include("../../views/partials/admin/header") %>

<main class="col-12 col-md-10 px-3 pt-3">

    <!-- HEADER -->
    <div class="page-header my-3">
        <h4 class="fw-bold">Orders</h4>
    </div>

    <!-- FILTER SECTION -->
    <div class="filter-card mb-4">
        <form onsubmit="event.preventDefault(); loadData(1);">
            <div class="row g-2 justify-content-center align-items-center">

                <!-- SEARCH -->
                <div class="col-12 col-md-4">
                    <input
                        type="text"
                        id="search"
                        name="search"
                        value="<%= search || '' %>"
                        placeholder="Search order..."
                        class="form-control"
                        autocomplete="off">
                </div>

                <!-- SEARCH BUTTON -->
                <div class="col-6 col-md-1">
                    <button class="btn btn-style w-100" type="submit">
                        Search
                    </button>
                </div>

                <!-- SORT -->
                <div class="col-6 col-md-2">
                    <select id="sort" class="form-select">
                        <option value="">Sort By</option>
                        <option value="newest" <%= sort === "newest" ? "selected" : "" %>>Newest</option>
                        <option value="oldest" <%= sort === "oldest" ? "selected" : "" %>>Oldest</option>
                    </select>
                </div>

                <!-- PAYMENT FILTER -->
                <div class="col-12 col-md-2">
                    <select id="filter" class="form-select">
                        <option value="">Payment Status</option>
                        <option value="Pending" <%= paymentStatus === "Pending" ? "selected" : "" %>>Pending</option>
                        <option value="Completed" <%= paymentStatus === "Completed" ? "selected" : "" %>>Completed</option>
                        <option value="Failed" <%= paymentStatus === "Failed" ? "selected" : "" %>>Failed</option>
                        <option value="Refunded" <%= paymentStatus === "Refunded" ? "selected" : "" %>>Refunded</option>
                    </select>
                </div>

                <!-- CLEAR -->
<% if (search || sort || paymentStatus) { %>
  <div class="col-12 col-md-1">
    <button
      type="button"
      class="btn btn-grey w-100"
      onclick="clearFilters()">
      Clear
    </button>
  </div>
<% } %>
            </div>
        </form>
    </div>

    <!-- TABLE -->
    <div class="table-responsive bg-white p-3 rounded shadow-sm">
        <table class="table align-middle table-hover">
            <thead class="table-head">
                <tr>
                    <th>Sl No</th>
                    <th>Order ID</th>
                    <th>Order Date</th>
                    <th>User Email</th>
                    <th>Total Amount</th>
                    <th>Payment Method</th>
                    <th>Payment Status</th>
                    <th>Order Concern</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>
                <% if (orders && orders.length > 0) { %>
                    <% orders.forEach((order, index) => { %>
                        <tr>
                            <td><%= ((currentPage - 1) * limit) + index + 1 %></td>
                            <td><%= order.orderId %></td>
                            <td><%= order.createdAt.toISOString().split('T')[0] %></td>
                            <td><%= order.userId.email %></td>
                            <td>â‚¹<%= order.totalPayable %></td>
                            <td><%= order.paymentMethod %></td>
                            <td>
                                <span class="badge bg-warning">
                                    <%= order.paymentStatus %>
                                </span>
                            </td>
                            <td>
                                <% order.orderedItems.forEach((item, idx) => { %>
                                    <%= item.cancellationRequest?.reason || '-' %>
                                    <%= idx < order.orderedItems.length - 1 ? ', ' : '' %>
                                <% }) %>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary"
                                    onclick="window.location.href='/admin/orders/<%= order.orderId %>'">
                                    View
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No orders found
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>

        <!-- PAGINATION -->
        <div class="d-flex justify-content-center mt-4">
            <nav>
                <ul class="pagination pagination-sm">

                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <button class="page-link"
                            onclick="loadData(<%= currentPage - 1 %>)"
                            <%= currentPage === 1 ? 'disabled' : '' %>>
                            Previous
                        </button>
                    </li>

                    <% 
                        let start = Math.max(1, currentPage - 2);
                        let end = Math.min(totalPages, currentPage + 2);
                    %>

                    <% for (let i = start; i <= end; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <button class="page-link" onclick="loadData(<%= i %>)">
                                <%= i %>
                            </button>
                        </li>
                    <% } %>

                    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                        <button class="page-link"
                            onclick="loadData(<%= currentPage + 1 %>)"
                            <%= currentPage === totalPages ? 'disabled' : '' %>>
                            Next
                        </button>
                    </li>

                </ul>
            </nav>
        </div>

    </div>
</main>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function loadData(page = 1) {
    const sort = document.getElementById('sort').value;
    const filter = document.getElementById('filter').value;
    const search = document.getElementById('search').value.trim();

    const url = `/admin/orders?search=${search}&sort=${sort}&paymentStatus=${filter}&page=${page}`;
    window.location.href = url;
}

document.getElementById('sort').addEventListener('change', (e) => {
    e.preventDefault();
    loadData(1);
});

document.getElementById('filter').addEventListener('change', (e) => {
    e.preventDefault();
    loadData(1);
});

document.getElementById('search').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        loadData(1);
    }
});

function clearFilters() {
    document.getElementById('search').value = "";
    document.getElementById('sort').value = "";
    document.getElementById('filter').value = "";
    loadData(1);
}

    </script>
</body>
</html>
