<%- include("../../views/partials/admin/header")%>

<style>
/* =====================
   BASE STYLES
   ===================== */
.text-brown {
  color: #912f2f !important;
}

.text-brown:hover {
  color: #912f2f;
}

.btn-brown {
  background-color: #912f2f;
  color: white;
  border: none;
}

.btn-brown:hover {
  background-color: #912f2f;
  color: white;
}

.pagination .page-item.active .page-link {
  background-color: #912f2f;
  border-color: #912f2f;
  color: white;
}

.pagination .page-link:hover {
  background-color: #912f2f;
  color: white;
}

.table-head th {
  background-color: #dbcfc5 !important;
  color: #070707 !important;
}

/* =====================
   TABLET RESPONSIVE
   ===================== */
@media (max-width: 992px) {
  main {
    padding: 1rem !important;
  }

  .table-responsive {
    overflow-x: auto;
  }

  .d-flex.justify-content-between {
    flex-wrap: wrap;
    gap: 10px;
  }

  .d-flex.justify-content-between form {
    flex-wrap: wrap;
    width: 100%;
  }

  #searchInput {
    width: 100% !important;
  }

  .btn {
    white-space: nowrap;
  }
}

/* =====================
   MOBILE RESPONSIVE
   ===================== */
@media (max-width: 576px) {

  h4 {
    font-size: 1.1rem;
    text-align: center;
  }

  /* Center header content */
  .d-flex.justify-content-between.align-items-center {
    flex-direction: column;
    align-items: center !important;
    gap: 12px;
  }

  /* Center search & button block */
  .d-flex.justify-content-between.align-items-center > .d-flex {
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  /* Center search form */
  .d-flex.justify-content-between.align-items-center form {
    justify-content: center;
    width: 100%;
  }

  #searchInput {
    max-width: 260px;
    text-align: center;
  }

  /* Center Add Category button */
  .btn-brown {
    max-width: 200px;
    width: 100%;
  }

  /* Table */
  table {
    font-size: 0.85rem;
  }

  th, td {
    white-space: nowrap;
  }

  img.category-img {
    width: 32px;
    height: 32px;
  }

  .action-icons a {
    margin-right: 6px;
  }

  /* Modal */
  .modal-dialog {
    max-width: 95%;
    margin: auto;
  }

  /* Pagination */
  .pagination {
    flex-wrap: wrap;
    gap: 4px;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Main Content -->
<main class="col-12 col-md-10 px-3 pt-3">

  <!-- Page Header & Search -->
  <div class="d-flex justify-content-between align-items-center my-3">
    <h4><strong>Categories</strong></h4>

    <div class="d-flex gap-2">
      <form class="d-flex gap-2">
        <input
          type="text"
          name="search"
          id="searchInput"
          placeholder="Search category..."
          class="form-control"
          style="width: 250px;"
          value="<%= typeof search !== 'undefined' ? search : '' %>"
          autocomplete="off"
        />

        <button class="btn btn-dark btn-sm" type="submit">Search</button>

        <% if (search) { %>
          <a href="/admin/categories" class="btn btn-outline-secondary btn-sm">Clear</a>
        <% } %>
      </form>

      <!-- Add Category Button -->
      <button
        class="btn btn-sm btn-brown"
        data-bs-toggle="modal"
        data-bs-target="#addCategoryModal">
        <i class="bi bi-plus-lg me-1"></i> Add Category
      </button>
    </div>
  </div>



        <!-- Categories Table -->
        <div class="table-responsive bg-white p-3 rounded shadow-sm">
            <table class="table align-middle table-hover">
                <thead class="table-head">
                    <tr>
                        <th>Sl No</th>
                        <th>Category Name</th>
                        <th>Image</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Offer</th>
                        <th>Valid Until</th>
                        <th>Add Offer</th>
                        <th>Subcategories</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% data.forEach((category,index)=>{ %>
                        <tr>
                            <td>
                                <%= index+1%>
                            </td>
                            <td>
                                <%= category.name%>
                            </td>
                            <td>
                                <img src="<%= category.categoryImage ? '/uploads/categories/' + category.categoryImage : 'https://via.placeholder.com/40' %>"
                                    class="category-img" width="40" height="40">
                            </td>
                            <td>
                                <%= category.description%>
                            </td>
                            <td class="action-icons">
                                <% if (category.isListed) { %>
                                    <button onclick="unlistCategory('<%= category._id%>')"
                                        class="btn btn-outline-success btn-sm" title="Click to Unlist">Listed</button>
                                    <% } else { %>
                                        <button onclick="listCategory('<%= category._id%>')"
                                            class="btn btn-outline-danger btn-sm" title="Click to List">Unlisted</button>
                                        <% } %>
                            </td>
                            <td>
                                <%= category.categoryOffer ? category.categoryOffer + "%" : "-" %>
                            </td>
                            <% let formattedDate=category.endDate ? new
                                Date(category.endDate).toLocaleDateString('en-GB') : "-" ; %>
                                <td>
                                    <%= formattedDate %>
                                </td>
                                <td>
                                    <% if (category.categoryOffer) { %>
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="removeOffer('<%= category._id %>')">
                                            Remove Offer
                                        </button>
                                        <% } else { %>
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="openAddOfferModal('<%= category._id %>')"
                                                data-bs-toggle="modal" data-bs-target="#addOfferModal">
                                                Add Offer
                                            </button>
                                            <% } %>
                                </td>
                                <td class="text-center">
                                    <a href="/admin/subcategories/<%= category._id %>" title="View Subcategories">
                                        <i class="fas fa-layer-group text-brown"></i>
                                </td>
                                <td class="action-icons">

                                    <a href="#" title="Edit" data-bs-toggle="modal" data-bs-target="#editCategoryModal"
    data-id="<%= category._id %>"
    data-name="<%= category.name %>"
    data-description="<%= category.description %>"
    data-image="<%= category.categoryImage ? '/uploads/categories/' + category.categoryImage : 'https://via.placeholder.com/100' %>">
    <i class="fas fa-edit text-brown"></i>
</a>
                                    <a href="#" title="Delete" onclick="deleteCategory('<%= category._id %>')">
                                        <i class="fas fa-trash text-danger"></i>
                                    </a>
                                </td>
                        </tr>
                        <% }) %>
                </tbody>
            </table>
            <!-- ADD CATEGORY MODAL -->
            <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-md"> <!-- changed modal-lg to modal-md -->
                    <form id="addCategoryForm" class="modal-content p-4 rounded-4 border-0"
                        enctype="multipart/form-data" method="POST" action="/admin/addCategory">

                        <!-- Header -->
                        <div class="modal-header p-3 mb-3" style="background-color: #912f2f; border-radius: 0.5rem;">
                            <h5 class="modal-title text-white fw-bold" id="addCategoryModalLabel">Add Category</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body">
                            <div class="row g-3">
                                <!-- Category Name -->
                                <div class="col-12">
                                    <label for="categoryName" class="form-label fw-semibold">Category Name</label>
                                    <input type="text" name="categoryName" class="form-control rounded-3"
                                        id="categoryName" />
                                    <div id="nameError" class="error-msg text-danger"></div>
                                </div>

                                <!-- Image -->
                                <div class="col-12">
                                    <label for="categoryImage" class="form-label fw-semibold">Image</label>
                                    <input type="file" name="categoryImage" id="categoryImage"
                                        class="form-control rounded-3" accept="image/png, image/jpeg" />
                                    <div id="imageError" class="error-msg text-danger"></div>
                                </div>

                                <!-- Description -->
                                <div class="col-12">
                                    <label for="categoryDescription" class="form-label fw-semibold">Description</label>
                                    <textarea name="description" class="form-control rounded-3" id="categoryDescription"
                                        rows="3"></textarea>
                                    <div id="descriptionError" class="error-msg text-danger"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer border-0 mt-3">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="reset" class="btn btn-outline-secondary rounded-3 px-4">Cancel</button>
                                <button type="submit" class="btn" style="background-color: #912f2f; color: white;">Save
                                    Category</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
             <!-- ADD BRAND OFFER MODAL -->
<div class="modal fade" id="addOfferModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content p-4 rounded-4 border-0">

      <form id="addOfferForm" onsubmit="addCategoryOffer(event)">

        <div class="modal-header p-3 mb-3"
          style="background-color:#912f2f;border-radius:0.5rem;">
          <h5 class="modal-title text-white fw-bold">
            Select Offer
          </h5>
          <button type="button" class="btn-close btn-close-white"
            data-bs-dismiss="modal"></button>
        </div>

        <small id="offerError" class="text-danger"></small>

        <!-- hidden brand -->
        <input type="hidden" id="offerCategoryId" name="categoryId" >

        <div class="modal-body">

          <% if (offers.length === 0) { %>
            <p class="text-center text-muted">No offers available</p>
          <% } else { %>

            <div class="list-group">

              <% offers.forEach(offer => { %>
                <label class="list-group-item d-flex justify-content-between align-items-center">
  <div>
    <input
      class="form-check-input me-2"
      type="radio"
      name="offerId"
      value="<%= offer._id %>"
      
    >
    
    <!-- OFFER NAME -->
    <strong ><%= offer.offerName %></strong><br>
    

    <!-- DISCOUNT + DATE -->
    <small class="text-muted">
      <%= offer.discount %>% |
      <%= new Date(offer.startDate).toLocaleDateString('en-GB') %> -
      <%= new Date(offer.endDate).toLocaleDateString('en-GB') %>
    </small>
  </div>

  <!-- BADGE -->
  <span class="badge bg-success">
    <%= offer.discount %>%
  </span>
</label>

              <% }) %>

            </div>

          <% } %>

        </div>

        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary"
            data-bs-dismiss="modal">Cancel</button>

          <button type="submit"
            class="btn"
            style="background-color:#912f2f;color:white">
            Apply Offer
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

            <!-- EDIT CATEGORY MODAL -->
            <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-md">
                    <form id="editCategoryForm" class="modal-content p-4 rounded-4 border-0"
                        enctype="multipart/form-data" method="POST" action="#">
                        <!-- Hidden ID -->
                        <input type="hidden" id="edit-category-id" name="categoryId" />

                        <!-- Header -->
                        <div class="modal-header p-3 mb-3" style="background-color: #912f2f; border-radius: 0.5rem;">
                            <h5 class="modal-title text-white fw-bold" id="editCategoryModalLabel">Edit Category</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body">
                            <div class="row g-3">
                                <!-- Category Name -->
                                <div class="col-12">
                                    <label for="edit-category-name" class="form-label fw-semibold">Category Name</label>
                                    <input type="text" name="categoryName" class="form-control rounded-3"
                                        id="edit-category-name" />
                                    <div id="editNameError" class="error-msg"></div>
                                </div>

                                <!-- Description -->
                                <div class="col-12">
                                    <label for="edit-category-description"
                                        class="form-label fw-semibold">Description</label>
                                    <textarea name="description" class="form-control rounded-3"
                                        id="edit-category-description" rows="3"></textarea>
                                    <div id="editDescriptionError" class="error-msg"></div>
                                </div>

                                <!-- Existing Image -->
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Current Image</label><br />
                                    <img id="existing-category-image" src="" alt="Category Image"
                                        style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px" />
                                </div>

                                <!-- Upload New Image -->
                                <div class="col-12">
                                    <label for="edit-category-image-upload" class="form-label fw-semibold">Change Image
                                        (optional)</label>
                                    <input type="file" name="categoryImage" id="edit-category-image-upload"
                                        class="form-control rounded-3" accept="image/png, image/jpeg" />
                                    <div id="editImageError" class="error-msg"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer border-0 mt-3">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-outline-secondary rounded-3 px-4"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn"
                                    style="background-color: #912f2f; color: white;">Update Category</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>




            <!-- Pagination -->
            <div class="d-flex justify-content-center mt-4">
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <% for(let i=1; i <=totalPages; i++){ %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link"
                                    href="/admin/categories?page=<%= i %><%= search ? '&search=' + search : '' %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>
                    </ul>
                </nav>
            </div>
        </div>
    </main>

    <script>
        //add Category
        document.getElementById('addCategoryForm').addEventListener('submit', async function (e) {
            e.preventDefault()
            const form = e.target;
            let formdata = new FormData(form)

            if (addCategoryFormvalidate(formdata)) {
                await sendData(formdata)
            }


        })

        function addCategoryFormvalidate(formdata) {
            const name = formdata.get('categoryName').trim()
            const image = formdata.get('categoryImage')
            const description = formdata.get('description').trim()
            let hasError=false
            if (!name) {
                document.getElementById('nameError').textContent="Category name is required"
                hasError=true
            }
            if ( !image || !image.name) {
                document.getElementById('imageError').textContent="Image name is required"
                hasError=true
            }
            if (!description ) {
                document.getElementById('descriptionError').textContent="Description name is required"
                hasError=true
            }



            const allowedTypes = ["image/jpeg", "image/png"];
            if (!allowedTypes.includes(image.type)&& image.name) {
                document.getElementById('imageError').textContent="Only JPEG and PNG files are required"
                hasError=true
            }

            return hasError? false:true
        }


        async function sendData(formdata) {
            try {
                const response = await fetch('/admin/addCategory', {
                    method: 'POST',
                    body: formdata
                })

                const result = await response.json()

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#198754'
                    }).then(() => {
                        window.location.reload()
                    })
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    })
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Server Error',
                    text: "Something went wrong",
                    confirmButtonColor: '#dc3545'
                })
            }
        }

        //  Add Offer Modal
        let selectedCategoryId = null;

        // Set category ID when opening the modal
        function openAddOfferModal(categoryId) {
            selectedCategoryId = categoryId;
            document.getElementById('offerCategoryId').value=categoryId
            document.getElementById('offerPercentage').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
        }

 async function addCategoryOffer(e) {
  e.preventDefault();

  const categoryId= document.getElementById('offerCategoryId').value;
  const offerId = document.querySelector('input[name="offerId"]:checked')?.value;

  if (!offerId) {
    document.getElementById('offerError').innerText='Select an offer'
    return;
  }

  try {
    const response = await fetch('/admin/addCategoryOffer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ categoryId, offerId })
    });

    const result = await response.json();

    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: result.message,
        confirmButtonColor: '#198754'
      }).then(() => {
        window.location.reload();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: result.message
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Server Error',
      text: 'Something went wrong'
    });
  }
}


        // Deleting offer
        function removeOffer(categoryId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will remove the offer from this category!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/removeCategoryOffer', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ categoryId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Deleted!',
                                    'The offer has been successfully removed.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    data.message || 'Failed to delete the offer.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'Something went wrong while deleting the offer.',
                                'error'
                            );
                        });
                }
            });
        }

        // unlist category
        function unlistCategory(categoryId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will unlist the category!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Unlist!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/unlistCategory', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ categoryId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Unlisted!',
                                    'The category unlisted Succesfully.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    data.message || 'Failed to unlist.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'Something went wrong while unlisting the category.',
                                'error'
                            );
                        });
                }
            });
        }

        // list category
        function listCategory(categoryId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will unlist the category!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Unlist!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/listCategory', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ categoryId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Unlisted!',
                                    'The category listed Succesfully.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    data.message || 'Failed to unlist.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'Something went wrong while listing the category.',
                                'error'
                            );
                        });
                }
            });
        }

        //edit category
        const editCategoryModal = document.getElementById('editCategoryModal');

        editCategoryModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Link that triggered the modal

            // Extract values from data-* attributes
            const categoryId = button.getAttribute('data-id');
            const categoryName = button.getAttribute('data-name');
            const categoryDescription = button.getAttribute('data-description');
            const categoryImage = button.getAttribute('data-image');

            // Fill modal fields
            document.getElementById('edit-category-id').value = categoryId;
            document.getElementById('edit-category-name').value = categoryName;
            document.getElementById('edit-category-description').value = categoryDescription;
            document.getElementById('existing-category-image').src = categoryImage;
        });

        document.getElementById('editCategoryForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            // Get ID from hidden input
            const categoryId = document.getElementById('edit-category-id').value;

            try {
                const response = await fetch(`/admin/editCategory/${categoryId}`, {
                    method: 'PATCH',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: result.message,
                        confirmButtonColor: '#198754'
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed!',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Something went wrong',
                    confirmButtonColor: '#dc3545'
                });
            }
        });

        async function deleteCategory(categoryId) {
            // Show confirmation popup
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This category will be permanently deleted!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {

                    const response = await fetch('/admin/deleteCategory', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ categoryId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: data.message,
                            confirmButtonColor: '#198754'
                        }).then(() => window.location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed',
                            text: data.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }

                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Server Error',
                        text: 'Something went wrong',
                        confirmButtonColor: '#dc3545'
                    });
                }
            }
        }

    </script>

    <%- include("../../views/partials/admin/footer")%>