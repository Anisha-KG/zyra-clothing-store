<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin | Offer Management</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .btn-brown { background-color: #912f2f; color: #fff; }
    .table-head th { background-color: #dbcfc5; }
    .icon-btn {
      border: none;
      background: none;
      cursor: pointer;
    }
    .icon-btn:hover {
      opacity: 0.7;
    }
  </style>
</head>

<body>
<%- include("../../views/partials/admin/header") %>

<main class="col-12 col-md-10 px-3 pt-3">

  <div class="d-flex justify-content-between align-items-center my-3">
    <h4><strong>Offer Management</strong></h4>
    <button class="btn btn-sm btn-brown" onclick="openAddModal()">Add Offer</button>
  </div>

<!-- TABLE -->
<div class="table-responsive bg-white p-3 rounded shadow-sm">
  <table class="table table-hover">
    <thead class="table-head">
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Discount</th>
        <th>Start</th>
        <th>End</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <% offers.forEach((offer, i) => { %>
      <tr>
        <td><%= i + 1 %></td>
        <td><%= offer.offerName %></td>
        <td><%= offer.discount %>%</td>
        <td><%= new Date(offer.startDate).toLocaleDateString('en-GB') %></td>
        <td><%= new Date(offer.endDate).toLocaleDateString('en-GB') %></td>

        <!-- STATUS BUTTON -->
        <td>
          <% if (!offer.isDeleted) { %>
            <button
              class="btn btn-sm btn-outline-danger"
              onclick="unlistOffer('<%= offer._id %>')">
              Unlist
            </button>
          <% } else { %>
            <button
              class="btn btn-sm btn-outline-success"
              onclick="listOffer('<%= offer._id %>')">
              List
            </button>
          <% } %>
        </td>

        <!-- ACTION -->
        <td>
          <button
            class="icon-btn text-primary"
            onclick='openEditModal(<%- JSON.stringify(offer) %>)'>
            <i class="bi bi-pencil-square"></i>
          </button>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal fade" id="offerModal">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content p-4">

      <div class="modal-header">
        <h5 class="modal-title">Add Offer</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="offerForm">
        <input type="hidden" id="offerId">

        <div class="modal-body row g-3">

          <div class="col-12">
            <label class="form-label">Offer Name</label>
            <input id="offerName" class="form-control" required>
          </div>

          <div class="col-12">
            <label class="form-label">Discount (%)</label>
            <input id="discount" type="number" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Start Date</label>
            <input id="startDate" type="date" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">End Date</label>
            <input id="endDate" type="date" class="form-control" required>
          </div>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-brown">Save</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let modal;
let isEdit = false;

function openAddModal() {
  isEdit = false;
  offerForm.reset();
  offerId.value = '';
  document.querySelector('.modal-title').innerText = 'Add Offer';
  modal = new bootstrap.Modal(offerModal);
  modal.show();
}

function openEditModal(offer) {
  isEdit = true;

  offerId.value = offer._id;
  offerName.value = offer.offerName;
  discount.value = offer.discount;
  startDate.value = offer.startDate.split('T')[0];
  endDate.value = offer.endDate.split('T')[0];

  document.querySelector('.modal-title').innerText = 'Edit Offer';
  modal = new bootstrap.Modal(offerModal);
  modal.show();
}

/* SUBMIT FORM */
offerForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    offerName: offerName.value,
    discount: discount.value,
    startDate: startDate.value,
    endDate: endDate.value
  };

  const url = isEdit
    ? `/admin/offerManagement/${offerId.value}`
    : `/admin/offerManagement`;

  const method = isEdit ? 'PUT' : 'POST';

  try {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      Swal.fire(
        isEdit ? 'Offer updated!' : 'Offer added!',
        data.message,
        'success'
      ).then(() => {
        location.reload();
      });
    } else {
      Swal.fire(
        'Error!',
        data.message || 'Failed to save offer.',
        'error'
      );
    }
  } catch (error) {
    Swal.fire(
      'Error!',
      'Something went wrong while saving the offer.',
      'error'
    );
  }
});

/* DELETE OFFER */


function unlistOffer(id) {
  Swal.fire({
    title: 'Are you sure?',
    text: "This will remove the offer!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Remove!'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/unlistOffer/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire(
            'Offer removed!',
            data.message,
            'success'
          ).then(() => {
            location.reload();
          });
        } else {
          Swal.fire(
            'Error!',
            data.message || 'Failed to remove offer.',
            'error'
          );
        }
      })
      .catch(() => {
        Swal.fire(
          'Error!',
          'Something went wrong while removing offer.',
          'error'
        );
      });
    }
  });
}



function listOffer(id) {
  Swal.fire({
    title: 'Are you sure?',
    text: "This will list the offer!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Remove!'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/listOffer/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire(
            'Offer removed!',
            data.message,
            'success'
          ).then(() => {
            location.reload();
          });
        } else {
          Swal.fire(
            'Error!',
            data.message || 'Failed to remove offer.',
            'error'
          );
        }
      })
      .catch(() => {
        Swal.fire(
          'Error!',
          'Something went wrong while removing offer.',
          'error'
        );
      });
    }
  });
}
</script>

</body>
</html>
