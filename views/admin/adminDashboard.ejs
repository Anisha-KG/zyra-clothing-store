<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }

    .sidebar {
      min-height: 100vh;
      background: linear-gradient(180deg, #212529, #111);
    }

    .sidebar a {
      color: #adb5bd;
      padding: 12px 15px;
      display: block;
      text-decoration: none;
      border-radius: 6px;
      margin-bottom: 5px;
    }

    .sidebar a:hover {
      background: #0d6efd;
      color: #fff;
    }

    .content {
      padding: 25px;
    }

    .card {
      border: none;
      border-radius: 14px;
    }

    .stat-card h4 {
      font-weight: 700;
    }

    .stat-card p {
      font-size: 14px;
      margin-bottom: 5px;
    }

    .filter-box {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .top-list div {
      padding: 6px 0;
      border-bottom: 1px dashed #eaeaea;
    }

    .top-list div:last-child {
      border-bottom: none;
    }

    .date-range {
      display: none;
    }
    .btn-custom {
            background-color: #912f2f !important;
            color: white !important;
            border: none;
        }
  </style>
</head>

<body>

<div class="container-fluid">
  <div class="row">

    <%- include("../../views/partials/admin/header") %>

    <!-- MAIN CONTENT -->
    <div class="col-md-10 content">

      <h4 class="mb-4 fw-bold">Dashboard Overview</h4>

      <!-- TOP CARDS -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card p-3 shadow-sm stat-card">
            <p class="text-muted">Total Customers</p>
            <h4><%= totalCustomers %></h4>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card p-3 shadow-sm stat-card">
            <p class="text-muted">Total Orders</p>
            <h4><%= totalOrders %></h4>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card p-3 shadow-sm stat-card">
            <p class="text-muted">Total Sales</p>
            <h4 class="text-success">â‚¹ <%= totalSales.toLocaleString() %></h4>
          </div>
        </div>

        
      </div>

      <!-- FILTER -->
      <form method="GET" class="filter-box mb-4" onsubmit="return validateFilter()">
        <div class="row g-2 align-items-end">

          <div class="col-md-3">
            <label class="form-label fw-semibold">Filter</label>
            <select name="filter" id="filter" class="form-select" onchange="toggleDateInputs()">
              <option value="daily" <%= filter === 'daily' ? 'selected' : '' %>>Day</option>
              <option value="weekly" <%= filter === 'weekly' ? 'selected' : '' %>>Week</option>
              <option value="monthly" <%= filter === 'monthly' ? 'selected' : '' %>>Month</option>
              <option value="yearly" <%= filter === 'yearly' ? 'selected' : '' %>>Year</option>
              <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom</option>
            </select>
          </div>

          <!-- START DATE -->
          <div class="col-md-3 date-range">
            <label class="form-label fw-semibold">Start Date</label>
            <input
              type="date"
              name="from"
              id="fromDate"
              class="form-control"
              value="<%= typeof fromDate !== 'undefined' ? fromDate : '' %>"
            >
          </div>

          <!-- END DATE -->
          <div class="col-md-3 date-range">
            <label class="form-label fw-semibold">End Date</label>
            <input
              type="date"
              name="to"
              id="toDate"
              class="form-control"
              value="<%= typeof toDate !== 'undefined' ? toDate : '' %>"
            >
          </div>

          <div class="col-md-3">
            <button class="btn btn-custom w-100">Apply</button>
          </div>

        </div>
      </form>

      <!-- SALES GRAPH -->
      <div class="card p-4 mb-4 shadow-sm">
        <h5 class="fw-semibold mb-3">Sales Activity</h5>
        <canvas id="salesChart"></canvas>
      </div>

      <!-- TOP 3 SECTION -->
      <div class="row g-3">

        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6 class="fw-bold mb-3">Top 3 Products</h6>
            <div class="top-list">
              <% topProducts.forEach(p => { %>
                <div class="d-flex justify-content-between">
                  <span><%= p.name %></span>
                  <strong><%= p.sold %></strong>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6 class="fw-bold mb-3">Top 3 Categories</h6>
            <div class="top-list">
              <% topCategories.forEach(c => { %>
                <div class="d-flex justify-content-between">
                  <span><%= c._id %></span>
                  <strong><%= c.sold %></strong>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6 class="fw-bold mb-3">Top 3 Brands</h6>
            <div class="top-list">
              <% topBrands.forEach(b => { %>
                <div class="d-flex justify-content-between">
                  <span><%= b._id %></span>
                  <strong><%= b.sold %></strong>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- CHART -->
<script>
  new Chart(document.getElementById('salesChart'), {
    type: 'bar',
    data: {
      labels: <%- JSON.stringify(salesGraph.map(s => s._id)) %>,
      datasets: [{
        label: 'Sales',
        data: <%- JSON.stringify(salesGraph.map(s => s.sales)) %>,
        backgroundColor: '#cc8e8e',
        borderRadius: 6
      }]
    }
  });

  function toggleDateInputs() {
    const filter = document.getElementById('filter').value;
    document.querySelectorAll('.date-range').forEach(el => {
      el.style.display = filter === 'custom' ? 'block' : 'none';
    });
  }

  function validateFilter() {
    const filter = document.getElementById('filter').value;

    if (filter === 'custom') {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;

      if (!from || !to) {
        alert('Please select both start and end dates');
        return false;
      }

      if (new Date(from) > new Date(to)) {
        alert('Start date cannot be after end date');
        return false;
      }
    }
    return true;
  }

  toggleDateInputs();
</script>

</body>
</html>
