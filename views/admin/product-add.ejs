<%- include("../../views/partials/admin/header")%>

<style>
/* Sidebar styles */
.header .sidebar {
    position: absolute;
    top: 0;
    left: 0;
    width: 250px;
    height: 100vh;
    background: #2c2c2c;
    padding: 20px;
    color: #fff;
    z-index: 1000;
}
.header .sidebar ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.header .sidebar ul li {
    margin-bottom: 15px;
}
.header .sidebar ul li a {
    color: #fff;
    text-decoration: none;
}

/* Main content */
.main-content {
    margin-left: 250px;
    padding: 30px;
    background: #f5f5f5;
    min-height: 100vh;
}

/* Form container */
.form-container {
    background: #fff;
    padding: 25px 30px;
    border-radius: 12px;
    max-width: 900px;
    margin: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.form-container h2 {
    margin-bottom: 5px;
    font-size: 24px;
    font-weight: 600;
}
.form-container p {
    margin-bottom: 20px;
    color: #555;
}

/* Form layout */
.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}
.form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.form-group.full-width {
    flex: 100%;
}
.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
}
.form-group input,
.form-group textarea,
.form-group select {
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
}
textarea {
    min-height: 80px;
    resize: vertical;
}

/* Buttons */
.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}
.cancel-btn {
    padding: 10px 20px;
    border-radius: 6px;
    border: 1px solid #b4654b;
    background: #fff;
    color: #b4654b;
    cursor: pointer;
}
.add-btn {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    background: #b4654b;
    color: #fff;
    cursor: pointer;
}

/* Image Upload Box */
.image-upload-box {
    width: 100%;
    min-height: 150px;
    border: 2px dashed #b08968;
    border-radius: 10px;
    background-color: #fffaf5;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    gap: 10px;
    overflow-x: auto;
    transition: all 0.3s ease;
}
.image-upload-label {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6b4f4f;
    font-weight: 500;
    background: #f2e2d2;
    border-radius: 8px;
    padding: 8px 12px;
    transition: all 0.2s ease;
}
.image-upload-label:hover {
    background: #e0c8b5;
}
.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ddd;
}
.image-wrapper {
    position: relative;
    display: inline-block;
}
.remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #ff6b6b;
    border: none;
    color: white;
    border-radius: 50%;
    font-size: 14px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
}
</style>

<main class="col-12 col-md-10 px-3 pt-3">
  <h2>Add New Product</h2>
  <p>Fill in the product details to add a new item to your inventory</p>

  <form id="addProduct" action="/admin/add-product" method="POST" enctype="multipart/form-data">
    <!-- Product Name & SKU -->
    <div class="form-row">
      <div class="form-group">
        <label>Product Name</label>
        <input  type="text" name="productName" placeholder="Enter product name" >
        <div id="productName-error" class="text-danger"></div>
      </div>
      
    </div>
    <div class="form-row">
  <div class="form-group">
    <label>Material</label>
    <input type="text" id="material" name="material" class="form-control">
    <div id="material-error" class="text-danger"></div>
  </div>

   <div class="form-group">
    <label>Status</label>
    <select id="status" name="status" class="form-control">
      <option value="">Select Status</option>
      <option value="available">Available</option>
      <option value="out_of_stock">Out of Stock</option>
      <option value="discontinued">Discontinued</option>
    </select>
    <div id="status-error" class="text-danger"></div>
  </div>
</div>
    <!-- Price & Offer -->
    <div class="form-row">
      <div class="form-group">
        <label>Regular Price</label>
        <input  type="number" name="regprice" placeholder="0.00" >
        <div id="regularprice-error" class="text-danger"></div>
      </div>
      <div class="form-group">
        <label>Final Price</label>
        <input type="number" name="finalPrice" placeholder="0.00">
        <div id="finalPrice-error" class="text-danger"></div>
      </div>
    </div>
    

    <!-- Description -->
    <div class="form-group full-width">
      <label>Product Description</label>
      <textarea name="description" placeholder="Enter detailed product description..."></textarea>
      <div id="description-error" class="text-danger"></div>
    </div>

    <!-- Category, Subcategory, Brand -->
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select name="category" id="category" >
          <option value="">Select Category</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
        <div id="category-error" class="text-danger"></div>
      </div>
      <div class="form-group">
        <label>Sub Category</label>
        <select name="subcategory" id="subcategory" >
          <option value="" disabled selected>Select Subcategory</option>
          
        </select>
        <div id="subcategory-error" class="text-danger"></div>
      </div>
      <div class="form-group">
        <label>Brand</label>
        <select name="brand" >
          <option value="">Select Brand</option>
          <% brands.forEach(b => { %>
            <option value="<%= b._id %>"><%= b.brandName %></option>
          <% }) %>
        </select>
        <div id="brand-error" class="text-danger"></div>
      </div>
    </div>

   
    

    <!-- Buttons -->
    <div class="form-actions">
      <button type="button" class="cancel-btn" onclick="window.history.back()">Cancel</button>
      <button type="submit" class="add-btn">Add Product</button>
    </div>
  </form>
</main>

<script>
  // Categories and subcategories data from server
  const categories = <%- JSON.stringify(categories) %>;
  const subcategories = <%- JSON.stringify(subcategories) %>;

  const categorySelect = document.getElementById('category');
  const subcategorySelect = document.getElementById('subcategory');

  // When a category is selected
  categorySelect.addEventListener('change', function () {
    const selectedCatId = this.value;
    console.log(selectedCatId); 
    

    // Clear existing subcategory options
    subcategorySelect.innerHTML = '<option value="" disabled selected>Select Subcategory</option>';

    if (!selectedCatId) return;

    // Filter subcategories that belong to the selected category
    const filteredSubcategories = subcategories.filter(
  subcat => //console.log(subcat.category)
  subcat.categoryId=== selectedCatId
);

    // Add the filtered subcategories to the dropdown
    filteredSubcategories.forEach(subcat => {
      const option = document.createElement('option');
      option.value = subcat._id;
      option.textContent = subcat.name;
      subcategorySelect.appendChild(option);
    });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('addProduct').addEventListener('submit', async function(e){
    e.preventDefault();
    console.log("Form submit clicked");

    document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

    const form = e.target;

    // Collect values from form fields
    const productData = {
      productName: form.productName.value.trim(),
      material: form.material.value.trim(),
      status: form.status.value,
      regprice: form.regprice.value,
      finalPrice: form.finalPrice.value,
      category: form.category.value,
      subcategory: form.subcategory.value,
      brand: form.brand.value,
      description: form.description.value.trim()
    };

    // Frontend validation
    let hasError = false;

    if(!productData.productName){
      document.getElementById('productName-error').innerText='Product name is required';
      hasError = true;
    }
    if(!productData.material){
      document.getElementById('material-error').innerText='Material is required';
      hasError = true;
    }
    if(!productData.status){
      document.getElementById('status-error').innerText='Please select the status';
      hasError = true;
    }
    if(!productData.regprice || Number(productData.regprice) <= 0){
      document.getElementById('regularprice-error').innerText='Please enter valid price';
      hasError = true;
    }
    if(!productData.finalPrice || Number(productData.finalPrice) <= 0 || Number(productData.finalPrice) >= Number(productData.regprice)){
      document.getElementById('finalPrice-error').innerText='Final price must be less than regular price and greater than 0';
      hasError = true;
    }
    if(!productData.category){
      document.getElementById('category-error').innerText='Please select category';
      hasError = true;
    }
    if(!productData.subcategory){
      document.getElementById('subcategory-error').innerText='Please select subcategory';
      hasError = true;
    }
    if(!productData.brand){
      document.getElementById('brand-error').innerText='Please select brand';
      hasError = true;
    }
    if(!productData.description){
      document.getElementById('description-error').innerText='Please add description';
      hasError = true;
    }

    if(!hasError){
      try{
        const response = await fetch('/admin/addProduct', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(productData)
        });

        const result = await response.json();
        if(result.success){
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: result.message,
            confirmButtonColor: '#198754'
          }).then(() => window.location.reload());
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message,
            confirmButtonColor: '#dc3545'
          });
        }
      } catch(error){
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: "Something went wrong",
          confirmButtonColor: '#dc3545'
        });
      }
    }
  });
});
</script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
