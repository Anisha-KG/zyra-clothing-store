<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report</title>

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .report-card {
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .filter-box {
            border-radius: 12px;
            padding: 20px;
            background: #fff;
        }

        .download-btn {
            min-width: 140px;
        }

       /* Global button style */
button, 
.btn,
.page-link {
    background-color: #912f2f !important;
    border-color: #912f2f !important;
    color: white !important;
}

/* Disabled buttons */
button:disabled, 
.page-link:disabled {
    background-color: #b87a7a !important;
    border-color: #b87a7a !important;
}

/* Reset Button - GREY */
.btn-reset {
    background-color: #6c757d !important; /* grey */
    border-color: #6c757d !important;
    color: white !important;
}

/* Active pagination button */
.page-item.active .page-link {
    background-color: #912f2f !important;
    border-color: #912f2f !important;
    color: white !important;
}

/* Non-active pagination buttons */
.page-link {
    color: white !important;
}.page-link {
    background-color: white !important;
    color: #912f2f !important;
    border: 1px solid #912f2f !important;
}

/* Active/current page */
.page-item.active .page-link {
    background-color: #912f2f !important;
    color: white !important;
    border-color: #912f2f !important;
}

/* Disabled buttons */
.page-link:disabled {
    background-color: #f0e0e0 !important;
    border-color: #e0caca !important;
    color: #aaa !important;
}
    </style>
</head>

<body class="bg-light">
    <%- include("../../views/partials/admin/header") %>

    <main class="col-12 col-md-10 px-3 pt-3">

        
    <div class="container py-4">

        <!-- Breadcrumb -->
        <div class="mb-3">
            <a href="/admin/dashboard" class="text-secondary text-decoration-none">Admin</a>
            /
            <span class="fw-semibold">Sales Report</span>
        </div>

        <!-- Title -->
        <h2 class="fw-bold mb-4">Sales Report</h2>

        <!-- Stats Row -->
        <div class="row g-3">

            <div class="col-md-4">
                <div class="bg-white shadow-sm p-4 report-card">
                    <p class="text-secondary mb-1">Total Orders</p>
                    <p class="stat-value"><%= totals.totalOrders %></p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="bg-white shadow-sm p-4 report-card">
                    <p class="text-secondary mb-1">Total Revenue</p>
                    <p class="stat-value">₹<%= totals.totalRevenue.toFixed(2) %></p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="bg-white shadow-sm p-4 report-card">
                    <p class="text-secondary mb-1">Total Discount</p>
                    <p class="stat-value">₹<%= totals.totalDiscount.toFixed(2) %></p>
                </div>
            </div>

        </div>

        <!-- Download Buttons -->
        <div class="d-flex justify-content-end gap-2 mt-3">
            <a href="/admin/sales-report/pdf?<%= new URLSearchParams(query).toString() %>"
               class="btn btn-danger download-btn">
                Download PDF
            </a>

            <a href="/admin/sales-report/excel?<%= new URLSearchParams(query).toString() %>"
               class="btn btn-success download-btn">
                Download Excel
            </a>
        </div>

        <!-- Filter Section -->
        <div class="filter-box shadow-sm mt-4">

            <h5 class="fw-semibold mb-3">Filters</h5>

            <form action="/admin/salesReport" method="GET" class="row g-3">

                <!-- Filter Type -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Filter Type</label>
                    <select name="filter" id="filter" class="form-select">
                        <option value="daily" <%= filter === "daily" ? "selected" : "" %>>Daily</option>
                        <option value="weekly" <%= filter === "weekly" ? "selected" : "" %>>Weekly</option>
                        <option value="monthly" <%= filter === "monthly" ? "selected" : "" %>>Monthly</option>
                        <option value="yearly" <%= filter === "yearly" ? "selected" : "" %>>Yearly</option>
                        <option value="custom" <%= filter === "custom" ? "selected" : "" %>>Custom</option>
                    </select>
                </div>

                <!-- From Date -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">From</label>
                    <input type="date" name="from" id="from" class="form-control"
                           value="<%= fromDate %>" <%= filter !== "custom" ? "disabled" : "" %>>
                </div>

                <!-- To Date -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">To</label>
                    <input type="date" name="to" id="to" class="form-control"
                           value="<%= toDate %>" <%= filter !== "custom" ? "disabled" : "" %>>
                </div>

                <!-- Buttons -->
                <div class="col-12">
                    <a href="/admin/salesReport" class="btn btn-reset">Reset</a>

                    <button type="submit" class="btn btn-dark">Apply Filter</button>
                </div>

            </form>

        </div>

        <!-- Orders Table Section -->
        <div class="bg-white shadow-sm mt-4 p-4 rounded">

            <h5 class="fw-semibold mb-3">Orders</h5>

            <% if (orders.length === 0) { %>

                <p class="text-center text-muted py-4">No orders found for this filter.</p>

            <% } else { %>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Subtotal</th>
                                <th>Total Payable</th>
                                <th>Discount</th>
                                <th>Payment</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
    <% orders.forEach(o => { %>
        <tr>
            <td><%= o.orderId %></td>
            <td><%= new Date(o.createdAt).toLocaleDateString("en-IN") %></td>
            <td>₹<%= o.subTotal?.toFixed(2) || "0.00" %></td>
            <td>₹<%= o.totalPayable?.toFixed(2) || "0.00" %></td>
            <td>₹<%= o.totalDiscount?.toFixed(2) || "0.00" %></td>
            <td><%= o.paymentMethod || "N/A" %></td>
            <td><%= o.user?.name || "N/A" %></td>
        </tr>
    <% }) %>
</tbody>
                    </table>
                </div>

            <% } %>

        </div>

        <!-- Pagination -->
       <nav class="mt-4">
    <ul class="pagination justify-content-center">

        <!-- Previous -->
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <button class="page-link" <%= currentPage === 1 ? 'disabled' : '' %> 
                onclick="sendGetRequest(<%= currentPage - 1 %>)">Previous</button>
        </li>

        <!-- Page numbers -->
        <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <button class="page-link" onclick="sendGetRequest(<%= i %>)"><%= i %></button>
            </li>
        <% } %>

        <!-- Next -->
        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <button class="page-link" <%= currentPage === totalPages ? 'disabled' : '' %> 
                onclick="sendGetRequest(<%= currentPage + 1 %>)">Next</button>
        </li>

    </ul>
</nav>


    </div>
    <%- include("../../views/partials/admin/footer")%>
    
    </main>
    


    <script>
        // Enable date fields only when "custom" selected
        document.querySelector("select[name='filter']").addEventListener("change", function () {
            const custom = this.value === "custom";
            document.querySelector("input[name='from']").disabled = !custom;
            document.querySelector("input[name='to']").disabled = !custom;
        });


       function sendGetRequest(page = 1) {
    const filter = document.getElementById('filter').value;
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;

    const url = `/admin/salesReport?page=${page}&filter=${encodeURIComponent(filter)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;

    window.location.href = url;
}
    </script>

</body>
</html>
