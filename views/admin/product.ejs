<%- include("../../views/partials/admin/header") %>

<style>
  /* Active page link color */
  .pagination .page-item.active .page-link {
      background-color: #912f2f;
      border-color: #912f2f;
      color: white; /* Text color */
  }

  /* Optional: Hover effect for non-active pages */
  .pagination .page-link:hover {
      background-color: #912f2f;
      color: white;
  }
  /* ======= TABLE STYLES ======= */
  .table-head th {
    background-color: #dbcfc5 !important;
    color: #1f1d1d !important;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
  }

  .table th,
  .table td {
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ======= BUTTONS ======= */
  .btn-custom {
    background-color: #912f2f;
    color: white;
    border: none;
  }

  .btn-custom:hover {
    background-color: #912f2f;
  }

  .btn-outline-custom {
    border: 1px solid #912f2f;
    color: #912f2f;
  }

  .btn-outline-custom:hover {
    background-color: #912f2f;
    color: white;
  }

  .action-icons button {
    margin: 0 3px;
  }

  .badge-available {
    background-color: #198754;
  }

  .badge-outofstock {
    background-color: #ffc107;
    color: black;
  }

  .badge-discontinued {
    background-color: #6c757d;
  }

  /* ======= RESPONSIVE FIXES ======= */
  @media (max-width: 992px) {
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table th,
    .table td {
      white-space: nowrap;
    }

    h4 {
      font-size: 1.1rem;
    }

    .btn,
    input,
    select {
      font-size: 0.85rem;
    }

    .btn-custom,
    .btn-outline-custom {
      padding: 0.25rem 0.6rem;
    }
  }

  @media (max-width: 576px) {
    .d-flex.gap-2 {
      flex-direction: column;
      gap: 0.5rem !important;
    }

    #searchInput {
      width: 100% !important;
    }

    .table img {
      width: 30px;
      height: 30px;
    }

    .btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<main class="col-12 col-md-10 px-3 pt-3">
  <!-- ======= PAGE HEADER & SEARCH ======= -->
  <div class="d-flex flex-wrap justify-content-between align-items-center my-3 gap-2">
    <h4 class="fw-bold mb-0">Products</h4>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <form class="d-flex flex-wrap gap-2" role="search">
        <input
          type="text"
          name="search"
          id="searchInput"
          placeholder="Search product..."
          class="form-control form-control-sm"
          style="width: 250px;"
          value="<%= typeof search !== 'undefined' ? search : '' %>"
          autocomplete="off"
        />
        <button class="btn btn-dark btn-sm" type="submit">Search</button>
        <% if (search) { %>
          <a href="/admin/brands" class="btn btn-outline-secondary btn-sm">Clear</a>
        <% } %>
      </form>

      <button class="btn btn-sm btn-custom" onclick="window.location.href='/admin/addProduct'">
        <i class="bi bi-plus-lg me-1"></i> Add Product
      </button>
    </div>
  </div>

  <!-- ======= PRODUCTS TABLE ======= -->
  <div class="bg-white p-3 rounded shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-head">
          <tr>
            <th>SL NO</th>
            <th>Product Name</th>
            <th>Brand</th>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Regular Price</th>
            <th>Final Price</th>
            <th>Material</th>
            <th>Status</th>
            <th>Offer</th>
            <th>Valid Until</th>
            <th>Actions</th>
            <th>Add Offer</th>
            <th>Edit</th>
            <th>Variant</th>
          </tr>
        </thead>
        <tbody>
          <% if (!products || products.length === 0) { %>
            <tr>
              <td colspan="15" class="text-center py-3">No products found</td>
            </tr>
          <% } else { %>
            <% products.forEach((product, index) => { %>
              <tr>
                <td><%= index + 1 + (currentPage - 1) * limit %></td>
                <td><%= product.name %></td>
                <td><%= product.brand?.brandName || 'N/A' %></td>
                <td><%= product.category?.name || 'N/A' %></td>
                <td><%= product.subcategory?.name || 'N/A' %></td>
                <td>₹<%= product.price.toFixed(2) %></td>
                <td>₹<%= product.finalPrice.toFixed(2) %></td>
                <td><%= product.material %></td>
                <td>
                  <% if (product.isBlocked) { %>
                    <span class="badge bg-dark">Not Available</span>
                  <% } else if (product.status?.toLowerCase() === 'available') { %>
                    <span class="badge badge-available">Available</span>
                  <% } else if (product.status?.toLowerCase() === 'out_of_stock') { %>
                    <span class="badge badge-outofstock">Out of Stock</span>
                  <% } else { %>
                    <span class="badge badge-discontinued">Discontinued</span>
                  <% } %>
                </td>
                <td><%= product.offer ? product.offer + "%" : "-" %></td>
                <% let formattedDate = product.offerValidUntil
                  ? new Date(product.offerValidUntil).toLocaleDateString('en-GB')
                  : "-"; %>
                <td><%= formattedDate %></td>

                <!-- ======= ACTIONS ======= -->
                <td class="action-icons">
                  <% if (!product.isBlocked) { %>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      title="Block Product"
                      onclick="confirmBlockProduct('<%= product._id %>', event)">
                      <i class="bi bi-slash-circle"></i> Block
                    </button>
                  <% } else { %>
                    <button
                      class="btn btn-outline-success btn-sm"
                      title="Unblock Product"
                      onclick="confirmUnblockProduct('<%= product._id %>')">
                      <i class="bi bi-check-circle"></i> Unblock
                    </button>
                  <% } %>
                  <button
                    class="btn btn-outline-danger btn-sm"
                    title="Delete Product"
                    onclick="confirmDeleteProduct('<%= product._id %>')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>

                <!-- ======= OFFER ======= -->
                <td>
                  <% if (!product.offer || product.offer === 0) { %>
                    <button
                      class="btn btn-outline-custom btn-sm"
                      title="Add Offer"
                      onclick="addOffer('<%= product._id %>')"
                      data-bs-toggle="modal"
                      data-bs-target="#addOfferModal">
                      <i class="bi bi-tag"></i> Add Offer
                    </button>
                  <% } else { %>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      title="Remove Offer"
                      onclick="removeOffer('<%= product._id %>')">
                      <i class="bi bi-x-circle"></i> Remove Offer
                    </button>
                  <% } %>
                </td>

                <!-- ======= EDIT ======= -->
                <td>
                  <button
                    type="button"
                    class="btn btn-outline-primary btn-sm"
                    onclick="window.location.href='/admin/edit-product/<%= product._id %>'"
                    title="Edit Product">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                </td>

                <!-- ======= VARIANT ======= -->
                <td>
                  <a
                    href="/admin/product/<%= product._id %>/variants"
                    class="btn btn-outline-custom btn-sm"
                    title="Add/View Variants">
                    <i class="bi bi-grid"></i> Variants
                  </a>
                </td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- ======= PAGINATION ======= -->
    <div class="d-flex justify-content-center mt-4">
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
              <a class="page-link" href="/admin/products?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
            </li>
          <% } %>
        </ul>
      </nav>
    </div>
  </div>
</main>

  <!-- ADD BRAND OFFER MODAL -->
<div class="modal fade" id="addOfferModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content p-4 rounded-4 border-0">

      <form id="addOfferForm" onsubmit="addCategoryOffer(event)">

        <div class="modal-header p-3 mb-3"
          style="background-color:#912f2f;border-radius:0.5rem;">
          <h5 class="modal-title text-white fw-bold">
            Select Offer
          </h5>
          <button type="button" class="btn-close btn-close-white"
            data-bs-dismiss="modal"></button>
        </div>

        <small id="offerError" class="text-danger"></small>

        <!-- hidden brand -->
        <input type="hidden" id="offerProductId" name="categoryId" >

        <div class="modal-body">

          <% if (offers.length === 0) { %>
            <p class="text-center text-muted">No offers available</p>
          <% } else { %>

            <div class="list-group">

              <% offers.forEach(offer => { %>
                <label class="list-group-item d-flex justify-content-between align-items-center">
  <div>
    <input
      class="form-check-input me-2"
      type="radio"
      name="offerId"
      value="<%= offer._id %>"
      
    >
    
    <!-- OFFER NAME -->
    <strong ><%= offer.offerName %></strong><br>
    

    <!-- DISCOUNT + DATE -->
    <small class="text-muted">
      <%= offer.discount %>% |
      <%= new Date(offer.startDate).toLocaleDateString('en-GB') %> -
      <%= new Date(offer.endDate).toLocaleDateString('en-GB') %>
    </small>
  </div>

  <!-- BADGE -->
  <span class="badge bg-success">
    <%= offer.discount %>%
  </span>
</label>

              <% }) %>

            </div>

          <% } %>

        </div>

        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary"
            data-bs-dismiss="modal">Cancel</button>

          <button type="submit"
            class="btn"
            style="background-color:#912f2f;color:white">
            Apply Offer
          </button>
        </div>

      </form>
    </div>
  </div>
</div>



<script>
  // Sidebar Toggle Fix (same as variant page)
  const toggleBtn = document.getElementById("sidebarToggle");
  const sidebar = document.querySelector(".sidebar");
  const mainContent = document.querySelector("main");

  if (toggleBtn && sidebar) {
    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      mainContent.classList.toggle("sidebar-collapsed");
    });
  }
</script>

<script>
  async function confirmBlockProduct(id, e) {
    const page =<%= currentPage%>
      e.preventDefault()
    const result = await Swal.fire({
      title: 'Are you sure?',
      text: 'This will block the product.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, block it!',
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch('/admin/blockProduct', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id }),
        });

        const data = await response.json();

        if (data.success) {
          Swal.fire(
            'Unlisted!',
            'The Brand listed Succesfully.',
            'success'
          ).then(() => {
            window.location.href = `/admin/products?page=${page}`;
          });
        } else {
          Swal.fire('Error!', data.message || 'Failed to block product.', 'error');
        }
      } catch (error) {
        Swal.fire('Error!', 'Something went wrong while blocking the product.', 'error');
        console.error(error);
      }
    }
  }

  async function confirmUnblockProduct(id) {

    const result= await Swal.fire({
      title:'Are you sure?',
      text:'This will unblock the product',
      icon:'warning',
      showCancelButton:true,
      confirmButtonColor:'#3085d6',
      confirmButtonText:'Yes unblock!',
      cancelButtonColor:'#d33'
    })

    if(result.isConfirmed){
     
      try{
        const res=await fetch('/admin/unblockProduct',{
        method:"PATCH",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id})
      })

      const response=await res.json()
      if(response.success){
        Swal.fire({
          icon:'success',
          title:'success',
          text: response.message,
          confirmButtonColor: '#198754'
        }).then(()=>{
          location.reload()
        })
      }else{
        Swal.fire({
          icon:'error',
          title:'Error',
          text: result.message,
          confirmButtonColor: '#198754'
        })
      }
      }catch(error){
         Swal.fire({
          icon:'error',
          title:'success',
          text:'Some thing went wrong',
          confirmButtonColor: '#198754'
        })
      }
    }
  }

  async function confirmDeleteProduct(id) {

    const result= await Swal.fire({
      title:'Are you sure?',
      text:'This will delete the product',
      icon:'warning',
      showCancelButton:true,
      confirmButtonColor:'#3085d6',
      confirmButtonText:'Yes delete!',
      cancelButtonColor:'#d33'
    })

    if(result.isConfirmed){
      
      try{
        const res=await fetch('/admin/deleteProduct',{
        method:"DELETE",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id})
      })

      const response=await res.json()
      if(response.success){
        Swal.fire({
          icon:'success',
          title:'success',
          text: response.message,
          confirmButtonColor: '#198754'
        }).then(()=>{
          location.reload()
        })
      }else{
        Swal.fire({
          icon:'error',
          title:'Error',
          text: result.message,
          confirmButtonColor: '#198754'
        })
      }
      }catch(error){
         Swal.fire({
          icon:'error',
          title:'success',
          text:'Some thing went wrong',
          confirmButtonColor: '#198754'
        })
      }
    }
  }

  function addOffer(id){
    document.getElementById('offerProductId').value=id
  }

  
 async function addCategoryOffer(e) {
  e.preventDefault();

  const productId= document.getElementById('offerProductId').value;
  const offerId = document.querySelector('input[name="offerId"]:checked')?.value;

  if (!offerId) {
    document.getElementById('offerError').innerText='Select an offer'
    return;
  }

  try {
    const response = await fetch('/admin/addProductOffer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, offerId })
    });

    const result = await response.json();

    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: result.message,
        confirmButtonColor: '#198754'
      }).then(() => {
        window.location.reload();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: result.message
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Server Error',
      text: 'Something went wrong'
    });
  }
}


      async function removeOffer(id) {
        
    const result= await Swal.fire({
      title:'Are you sure?',
      text:'This will remove Offer',
      icon:'warning',
      showCancelButton:true,
      confirmButtonColor:'#3085d6',
      confirmButtonText:'Yes Remove!',
      cancelButtonColor:'#d33'
    })

    if(result.isConfirmed){
      
      try{
        const res=await fetch('/admin/removeProductOffer',{
        method:"PATCH",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id})
      })

      const response=await res.json()
      if(response.success){
        Swal.fire({
          icon:'success',
          title:'success',
          text: response.message,
          confirmButtonColor: '#198754'
        }).then(()=>{
          location.reload()
        })
      }else{
        Swal.fire({
          icon:'error',
          title:'Error',
          text: result.message,
          confirmButtonColor: '#198754'
        })
      }
      }catch(error){
         Swal.fire({
          icon:'error',
          title:'success',
          text:'Some thing went wrong',
          confirmButtonColor: '#198754'
        })
      }
    }
        
      }
    



</script>
    
    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
