<%- include("../../views/partials/admin/header")%>

  <style>
    /* Table header dark brown */
    .table-head th {
      background-color: #a3654b !important;
      /* Dark brown */
      color: #0e0d0d !important;
      /* White text for contrast */
    }
  </style>
  <main class="col-12 col-md-10 px-3 pt-3">

    <!-- Page Header & Search -->
    <div class="d-flex justify-content-between align-items-center my-3">
      <h4><strong>Customers</strong></h4>
      <form class="d-flex gap-2" method="get" action="/admin/customers">
        <!--since it is get method value pass as query string-->
        <input type="text" name="search" id="searchInput" placeholder="Search category..." class="form-control"
          style="width: 250px;" value="<%= typeof search !== 'undefined' ? search : '' %>" autocomplete="off" />
        <button class="btn btn-dark btn-sm">Search</button>
        <% if(search){ %>
          <a href="/admin/customers" class="btn btn-outline-secondary btn-sm">Clear</a>
          <% } %>
      </form>
    </div>

    <!-- Customers Table -->
    <div class="table-responsive bg-white p-3 rounded shadow-sm">
      <table class="table align-middle table-hover">
        <thead class="table-head">
          <tr>
            <th>Customer</th>
            <th>Email</th>
            <th>Customer ID</th>
            <th>Orders</th>
            <th>Balance</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (data.length===0) { %>
            <tr>
              <td colspan="7" class="text-center">No customers found</td>
            </tr>
            <% } %>
              <% data.forEach((user)=> { %>
                <tr>
                  <td>
                    <img
                      src="<%= user.profilePicture ? '/uploads/profile/' + user.profilePicture : 'https://i.pravatar.cc/40?u=' + user._id %>"
                      class="rounded-circle me-2" width="40" height="40" alt="">
                    <%= user.name %>
                  </td>
                  <td>
                    <%= user.email %>
                  </td>
                  <td>
                    <%= user._id.toString().slice(-6).toUpperCase() %>
                  </td>
                  <td>
                    <%= user.orderHistory ? user.orderHistory.length : 0 %>
                  </td>
                  <td>â‚¹<%= user.wallet ? user.wallet.toFixed(2) : '0.00' %>
                  </td>
                  <td>
                    <% if (user.isBlocked) { %>
                      <span class="status-blocked">Blocked</span>
                      <% } else { %>
                        <span class="status-active">Active</span>
                        <% } %>
                  </td>
                  <td class="action-icons">
                    <% if (!user.isBlocked) { %>
                      <a href="#" onclick="blockCustomer(event,'<%= user._id %>')" title="Block">
                        <i class="fas fa-ban text-danger"></i>
                      </a>
                      <% } else { %>
                        <a href="#" onclick="unBlockCustomer(event,'<%= user._id %>')" title="Unblock">
                          <i class="fas fa-check text-success"></i>
                        </a>
                        <% } %>
                  </td>
                </tr>
                <% }) %>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="d-flex justify-content-center mt-4">
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <% for (let i=1; i <=totalPages; i++) { %>
              <li class="page-item <%= i == currentPage ? 'active' : '' %>">
                <a class="page-link" href="/admin/customers?page=<%= i %><%= search ? '&search=' + search : '' %>">
                  <%= i %>
                </a>
              </li>
              <% } %>
          </ul>
        </nav>
      </div>
    </div>
  </main>
  <script>
    async function blockCustomer(event, id) {
      event.preventDefault()
      const confirm = await Swal.fire({
        title: 'Are you sure?',
        text: "This will block this user!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Block User'
      });

      if (!confirm.isConfirmed) return;

      try {
        const response = await fetch('/admin/blockCustomer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }) // Send as object
        });

        const result = await response.json();

        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'User Blocked!',
            text: result.message,
            confirmButtonColor: '#198754'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Unable to block user',
            text: result.message || 'Please try again later.',
            confirmButtonColor: '#dc3545'
          });
        }

      } catch (err) {
        console.error('Error blocking user:', err);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: "Something went wrong. Please try again later.",
          confirmButtonColor: '#dc3545'
        });
      }
    }

    async function unBlockCustomer(event, id) {
      event.preventDefault()
      const confirm = await Swal.fire({
        title: 'Are you sure?',
        text: "This will unblock this user!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Block User'
      });

      if (!confirm.isConfirmed) return;

      try {
        const response = await fetch('/admin/unblockCustomer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }) // Send as object
        });

        const result = await response.json();

        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'User unblocked!',
            text: result.message,
            confirmButtonColor: '#198754'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Unable to unblock user',
            text: result.message || 'Please try again later.',
            confirmButtonColor: '#dc3545'
          });
        }

      } catch (err) {
        console.error('Error blocking user:', err);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: "Something went wrong. Please try again later.",
          confirmButtonColor: '#dc3545'
        });
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <%- include("../../views/partials/admin/footer")%>