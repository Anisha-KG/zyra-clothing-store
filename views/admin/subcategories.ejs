<%- include("../../views/partials/admin/header")%>     
<style>         
    /* Table header dark brown */         
    .table-head th {             
        background-color: #a3654b !important;             
        color: #0e0d0d !important;         
    }     
</style>      

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>      

<!-- Main Content -->     
<main class="col-12 col-md-10 px-3 pt-3">          

    <!-- Page Header & Search -->         
    <div class="d-flex justify-content-between align-items-center my-3">             
        <h4><strong>Subcategories</strong></h4>             
        <div class="d-flex gap-2">                 
            <form class="d-flex gap-2">                     
                <input type="text" name="search" id="searchInput" placeholder="Search subcategory..."                         
                    class="form-control" style="width: 250px;"                         
                    value="<%= typeof search !== 'undefined' ? search : '' %>" autocomplete="off" />                     
                <button class="btn btn-dark btn-sm" type="submit">Search</button>                     
                <% if (search) { %>                         
                    <a href="/admin/subcategories" class="btn btn-outline-secondary btn-sm">Clear</a>                         
                <% } %>                 
            </form>                  

            <!-- Add Subcategory Button -->                 
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSubcategoryModal">                     
                <i class="bi bi-plus-lg me-1"></i> Add Subcategory                 
            </button>             
        </div>         
    </div>          

    <!-- Subcategories Table -->         
    <div class="table-responsive bg-white p-3 rounded shadow-sm">             
        <table class="table align-middle table-hover">                 
            <thead class="table-head">                     
                <tr>                         
                    <th>Sl No</th>                         
                    <th>Subcategory Name</th>                         
                    <th>Parent Category</th>                         
                    <th>Image</th>                         
                    <th>Description</th>                         
                    <th>Status</th>                         
                    <th>Offer</th>                         
                    <th>Valid Until</th>                         
                    <th>Add Offer</th>                         
                    <th>Actions</th>                     
                </tr>                 
            </thead>                 
            <tbody>                     
                <% data.forEach((subcategory,index)=>{ %>                         
                    <tr>                             
                        <td><%= index+1 %></td>                             
                        <td><%= subcategory.name %></td>                             
                        <td><%= subcategory.parentCategory ? subcategory.parentCategory.name : '-' %></td>                             
                        <td>                                 
                            <img src="<%= subcategory.image ? '/uploads/subcategories/' + subcategory.image : 'https://via.placeholder.com/40' %>"                                     
                                class="subcategory-img" width="40" height="40">                             
                        </td>                             
                        <td><%= subcategory.description %></td>                             
                        <td class="action-icons">                                 
                            <% if (subcategory.isListed) { %>                                     
                                <button onclick="unlistSubcategory('<%= subcategory._id%>')" class="btn btn-success btn-sm" title="Click to Unlist">Listed</button>                                 
                            <% } else { %>                                     
                                <button onclick="listSubcategory('<%= subcategory._id%>')" class="btn btn-danger btn-sm" title="Click to List">Unlisted</button>                                 
                            <% } %>                             
                        </td>                             
                        <td><%= subcategory.subcategoryOffer ? subcategory.subcategoryOffer + "%" : "-" %></td>                             
                        <% let formattedDate=subcategory.endDate ? new Date(subcategory.endDate).toLocaleDateString('en-GB') : "-" ; %>                             
                        <td><%= formattedDate %></td>                             
                        <td>                                 
                            <% if (subcategory.subcategoryOffer) { %>                                     
                                <button class="btn btn-sm btn-outline-danger" onclick="removeSubOffer('<%= subcategory._id %>')">Remove Offer</button>                                 
                            <% } else { %>                                     
                                <button class="btn btn-sm btn-outline-primary" onclick="openAddSubOfferModal('<%= subcategory._id %>')" data-bs-toggle="modal" data-bs-target="#addSubOfferModal">Add Offer</button>                                 
                            <% } %>                             
                        </td>                             
                        <td class="action-icons">                                                                          
                            <a href="#" title="Edit" data-bs-toggle="modal" data-bs-target="#editSubcategoryModal" data-id="<%= subcategory._id %>" data-name="<%= subcategory.name %>" data-description="<%= subcategory.description %>" data-image="/uploads/<%= subcategory.image %>">                                     
                                <i class="fas fa-edit text-primary"></i>                                 
                            </a>                                 
                            <a href="#" title="Delete" onclick="deleteSubcategory('<%= subcategory._id %>')">                                     
                                <i class="fas fa-trash text-danger"></i>                                 
                            </a>                             
                        </td>                         
                    </tr>                     
                <% }) %>                 
            </tbody>             
        </table>             

        <!-- ADD SUBCATEGORY MODAL -->             
        <div class="modal fade" id="addSubcategoryModal" tabindex="-1" aria-labelledby="addSubcategoryModalLabel" aria-hidden="true">                 
            <div class="modal-dialog modal-dialog-centered modal-md">                     
                <form id="addSubcategoryForm" class="modal-content p-4 rounded-4 border-0" enctype="multipart/form-data" method="POST" action="/admin/addSubcategory">                          
                    <!-- Header -->                         
                    <div class="modal-header p-3 mb-3" style="background-color: #a05a3b; border-radius: 0.5rem;">                             
                        <h5 class="modal-title text-white fw-bold" id="addSubcategoryModalLabel">Add Subcategory</h5>                             
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>                         
                    </div>                          

                    <!-- Body -->                         
                    <div class="modal-body">                             
                        <div class="row g-3">                                 
                            <div class="col-12">                                     
                                <label for="subcategoryName" class="form-label fw-semibold">Subcategory Name</label>                                     
                                <input type="text" name="subcategoryName" class="form-control rounded-3" id="subcategoryName" />                                     
                                <div id="subNameError" class="error-msg"></div>                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="parentCategory" class="form-label fw-semibold">Parent Category</label>                                     
                                <select name="parentCategory" class="form-control rounded-3" id="parentCategory">                                         
                                    <% categories.forEach(cat => { %>                                             
                                        <option value="<%= cat._id %>"><%= cat.name %></option>                                         
                                    <% }) %>                                     
                                </select>                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="subcategoryImage" class="form-label fw-semibold">Image</label>                                     
                                <input type="file" name="subcategoryImage" id="subcategoryImage" class="form-control rounded-3" accept="image/png, image/jpeg" />                                     
                                <div id="subImageError" class="error-msg"></div>                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="subcategoryDescription" class="form-label fw-semibold">Description</label>                                     
                                <textarea name="description" class="form-control rounded-3" id="subcategoryDescription" rows="3"></textarea>                                     
                                <div id="subDescriptionError" class="error-msg"></div>                                 
                            </div>                             
                        </div>                         
                    </div>                          

                    <!-- Footer -->                         
                    <div class="modal-footer border-0 mt-3">                             
                        <div class="d-flex justify-content-end gap-2">                                 
                            <button type="reset" class="btn btn-outline-secondary rounded-3 px-4">Cancel</button>                                 
                            <button type="submit" class="btn" style="background-color: #a05a3b; color: white;">Save Subcategory</button>                             
                        </div>                         
                    </div>                     
                </form>                 
            </div>             
        </div>             

        <!-- ADD SUBCATEGORY OFFER MODAL -->             
        <div class="modal fade" id="addSubOfferModal" tabindex="-1" aria-labelledby="addSubOfferModalLabel" aria-hidden="true">                 
            <div class="modal-dialog modal-dialog-centered modal-md">                     
                <form id="addSubOfferForm" class="modal-content p-4 rounded-4 border-0" method="POST" action="/admin/addSubcategoryOffer">                          
                    <div class="modal-header p-3 mb-3" style="background-color: #a05a3b; border-radius: 0.5rem;">                             
                        <h5 class="modal-title text-white fw-bold" id="addSubOfferModalLabel">Add Subcategory Offer</h5>                             
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>                         
                    </div>                          
                    <div class="modal-body">                             
                        <div class="row g-3">                                 
                            <div class="col-12">                                     
                                <label for="subOfferPercentage" class="form-label fw-semibold">Offer Percentage (%)</label>                                     
                                <input type="number" name="offerPercentage" class="form-control rounded-3" id="subOfferPercentage" placeholder="Enter percentage (e.g. 10)" />                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="subStartDate" class="form-label fw-semibold">Start Date & Time</label>                                     
                                <input type="datetime-local" name="startDate" class="form-control rounded-3" id="subStartDate" />                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="subEndDate" class="form-label fw-semibold">End Date & Time</label>                                     
                                <input type="datetime-local" name="endDate" class="form-control rounded-3" id="subEndDate" />                                 
                            </div>                             
                        </div>                         
                    </div>                          
                    <div class="modal-footer border-0 mt-3">                             
                        <div class="d-flex justify-content-end gap-2">                                 
                            <button type="reset" class="btn btn-outline-secondary rounded-3 px-4">Cancel</button>                                 
                            <button type="submit" class="btn" style="background-color: #a05a3b; color: white;">Save Offer</button>                             
                        </div>                         
                    </div>                     
                </form>                 
            </div>             
        </div>             

        <!-- EDIT SUBCATEGORY MODAL -->             
        <div class="modal fade" id="editSubcategoryModal" tabindex="-1" aria-labelledby="editSubcategoryModalLabel" aria-hidden="true">                 
            <div class="modal-dialog modal-dialog-centered modal-md">                     
                <form id="editSubcategoryForm" class="modal-content p-4 rounded-4 border-0" enctype="multipart/form-data" method="POST" action="#">                         
                    <input type="hidden" id="edit-subcategory-id" name="subcategoryId" />                          
                    <div class="modal-header p-3 mb-3" style="background-color: #a05a3b; border-radius: 0.5rem;">                             
                        <h5 class="modal-title text-white fw-bold" id="editSubcategoryModalLabel">Edit Subcategory</h5>                             
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>                         
                    </div>                          
                    <div class="modal-body">                             
                        <div class="row g-3">                                 
                            <div class="col-12">                                     
                                <label for="edit-subcategory-name" class="form-label fw-semibold">Subcategory Name</label>                                     
                                <input type="text" name="subcategoryName" class="form-control rounded-3" id="edit-subcategory-name" />                                     
                                <div id="editSubNameError" class="error-msg"></div>                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="edit-subcategory-description" class="form-label fw-semibold">Description</label>                                     
                                <textarea name="description" class="form-control rounded-3" id="edit-subcategory-description" rows="3"></textarea>                                     
                                <div id="editSubDescriptionError" class="error-msg"></div>                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label class="form-label fw-semibold">Current Image</label><br />                                     
                                <img id="existing-subcategory-image" src="" alt="Subcategory Image" style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px" />                                 
                            </div>                                 
                            <div class="col-12">                                     
                                <label for="edit-subcategory-image-upload" class="form-label fw-semibold">Change Image (optional)</label>                                     
                                <input type="file" name="subcategoryImage" id="edit-subcategory-image-upload" class="form-control rounded-3" accept="image/png, image/jpeg" />                                     
                                <div id="editSubImageError" class="error-msg"></div>                                 
                            </div>                             
                        </div>                         
                    </div>                          
                    <div class="modal-footer border-0 mt-3">                             
                        <div class="d-flex justify-content-end gap-2">                                 
                            <button type="button" class="btn btn-outline-secondary rounded-3 px-4" data-bs-dismiss="modal">Cancel</button>                                 
                            <button type="submit" class="btn" style="background-color: #a05a3b; color: white;">Update Subcategory</button>                             
                        </div>                         
                    </div>                     
                </form>                 
            </div>             
        </div>              

        <!-- Pagination -->             
        <div class="d-flex justify-content-center mt-4">                 
            <nav>                     
                <ul class="pagination pagination-sm mb-0">                         
                    <% for(let i=1;i<=totalPages;i++){ %>                             
                        <li class="page-item <%= i==currentPage?'active':''%>">                                 
                            <a class="page-link" href="/admin/subcategories?page=<%= i%><%= search?'&search='+search:'' %>"><%= i %></a>                             
                        </li>                         
                    <% } %>                     
                </ul>                 
            </nav>             
        </div>         
    </div>     
</main>
