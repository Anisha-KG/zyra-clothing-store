<%- include("../../views/partials/admin/header")%>
    <style>
        /* Table header dark brown */
        .table-head th {
            background-color: #a3654b !important;
            color: #0e0d0d !important;
        }
        .btn-custom {
            background-color: #a05a3b;
            color: white;
            border: none;
        }

        .btn-custom:hover {
            background-color: #8e4e35;
        }
        .pagination .page-item.active .page-link {
            background-color: #a3654b;
            border-color: #a3654b;
            color: white;
            /* Text color */
        }

        .pagination .page-link:hover {
            background-color: #a3654b;
            color: white;
        }

    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Main Content -->
    <main class="col-12 col-md-10 px-3 pt-3">

        <!-- Page Header & Search -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h4><strong>Subcategories</strong></h4>
            <div class="d-flex gap-2">
                <form class="d-flex gap-2">
                    <input type="text" name="search" id="searchInput" placeholder="Search subcategory..."
                        class="form-control" style="width: 250px;"
                        value="<%= typeof search !== 'undefined' ? search : '' %>" autocomplete="off" />
                    <button class="btn btn-dark btn-sm" type="submit">Search</button>
                    <% if (search) { %>
                        <a href="/admin/subcategories/<%= category._id%>"
                            class="btn btn-outline-secondary btn-sm">Clear</a>
                        <% } %>
                </form>

                <!-- Add Subcategory Button -->
                <button class="btn btn-custom btn-sm " data-bs-toggle="modal" data-bs-target="#addSubcategoryModal">
                    <i class="bi bi-plus-lg me-1 "></i> Add Subcategory
                </button>
            </div>
        </div>

        <!-- Subcategories Table -->
        <div class="table-responsive bg-white p-3 rounded shadow-sm">
            <table class="table align-middle table-hover">
                <thead class="table-head">
                    <tr>
                        <th>Sl No</th>
                        <th>Subcategory Name</th>
                        <th>Parent Category</th>
                        <th>Image</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Offer</th>
                        <th>Valid Until</th>
                        <th>Add Offer</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% subcategories.forEach((subcategory,index)=>{ %>
                        <tr>
                            <td>
                                <%= index+1 %>
                            </td>
                            <td>
                                <%= subcategory.name %>
                            </td>
                            <td>
                                <%= category.name %>
                            </td>
                            <td>
                                <img src="<%= subcategory.image ? '/uploads/subcategory/' + subcategory.image : 'https://via.placeholder.com/40' %>"
                                    class="subcategory-img" width="40" height="40">
                            </td>
                            <td>
                                <%= subcategory.description %>
                            </td>
                            <td class="action-icons">
                                <% if (subcategory.isListed) { %>
                                    <button onclick="unlistSubcategory('<%= subcategory._id%>')"
                                        class="btn btn-outline-success btn-sm" title="Click to Unlist">Listed</button>
                                    <% } else { %>
                                        <button onclick="listSubcategory('<%= subcategory._id%>')"
                                            class="btn btn-outline-danger btn-sm" title="Click to List">Unlisted</button>
                                        <% } %>
                            </td>
                            <td>
                                <%= subcategory.offer ? subcategory.offer + "%" : "-" %>
                            </td>
                            <% let formattedDate=subcategory.endDate ? new
                                Date(subcategory.endDate).toLocaleDateString('en-GB') : "-" ; %>
                                <td>
                                    <%= formattedDate %>
                                </td>
                                <td>
                                    <% if (subcategory.offer) { %>
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="removeSubOffer('<%= subcategory._id %>')">Remove Offer</button>
                                        <% } else { %>
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="openAddSubOfferModal('<%= subcategory._id %>')"
                                                data-bs-toggle="modal" data-bs-target="#addSubOfferModal">Add
                                                Offer</button>
                                            <% } %>
                                </td>
                               <td class="action-icons">
                                            <a href="#" title="Edit" data-bs-toggle="modal"
                                                data-bs-target="#editSubcategoryModal"
                                                onclick="setEditmodal('<%= subcategory._id%>','<%= subcategory.name%>','<%= subcategory.image%>', `<%= subcategory.description%>`)">
                                                <i class="fas fa-edit text-primary"></i>
                                            </a>
                                            <a href="#" title="Delete" onclick="deleteSubcategory('<%= subcategory._id %>')">
                                                <i class="fas fa-trash text-danger"></i>
                                            </a>
                                        </td>
                        </tr>
                        <% }) %>
                </tbody>
            </table>

            <!-- ADD SUBCATEGORY MODAL -->
            <div class="modal fade" id="addSubcategoryModal" tabindex="-1" aria-labelledby="addSubcategoryModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-md">
                    <form id="addSubcategoryForm" class="modal-content p-4 rounded-4 border-0"
                        enctype="multipart/form-data" method="POST" onsubmit="addSubcategory(event)">

                        <!-- Header -->
                        <div class="modal-header p-3 mb-3" style="background-color: #a05a3b; border-radius: 0.5rem;">
                            <h5 class="modal-title text-white fw-bold" id="addSubcategoryModalLabel">
                                Add Subcategory for <%= category.name %>
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="subcategoryName" class="form-label fw-semibold">Subcategory Name</label>
                                    <input type="text" name="subcategoryName" class="form-control rounded-3"
                                        id="subcategoryName" />
                                    <input type="hidden" name="categoryId" value="<%= category._id %>">
                                    <div id="subNameError" class="error-msg text-danger"></div>
                                </div>

                                <div class="col-12">
                                    <label for="subcategoryImage" class="form-label fw-semibold">Image</label>
                                    <input type="file" name="subcategoryImage" id="subcategoryImage"
                                        class="form-control rounded-3" accept="image/png, image/jpeg" />
                                    <div id="subImageError" class="error-msg text-danger"></div>
                                </div>

                                <div class="col-12">
                                    <label for="subcategoryDescription"
                                        class="form-label fw-semibold">Description</label>
                                    <textarea name="description" class="form-control rounded-3"
                                        id="subcategoryDescription" rows="3"></textarea>
                                    <div id="subDescriptionError" class="error-msg text-danger"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer border-0 mt-3">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="reset" class="btn btn-outline-secondary rounded-3 px-4">Cancel</button>
                                <button type="submit" class="btn" style="background-color: #a05a3b; color: white;">Save
                                    Subcategory</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>




            <!-- ADD SUBCATEGORY OFFER MODAL -->
            <div class="modal fade" id="addSubOfferModal" tabindex="-1" aria-labelledby="addSubOfferModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-md">
                    <form id="addSubOfferForm" onsubmit="addSubcategoryOffer(event)"
                        class="modal-content p-4 rounded-4 border-0" method="POST" action="/admin/addSubcategoryOffer">
                        <div class="modal-header p-3 mb-3" style="background-color: #a05a3b; border-radius: 0.5rem;">
                            <h5 class="modal-title text-white fw-bold" id="addSubOfferModalLabel">Add Subcategory Offer
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="subOfferPercentage" class="form-label fw-semibold">Offer Percentage
                                        (%)</label>
                                    <input type="number" name="offerPercentage" class="form-control rounded-3"
                                        id="OfferPercentage" placeholder="Enter percentage (e.g. 10)" />
                                    <input type="hidden" name="subcategoryId" id="subcategoryId">
                                    <div id="offerError" class="error-msg text-danger"></div>
                                </div>
                                <div class="col-12">
                                    <label for="subStartDate" class="form-label fw-semibold">Start Date & Time</label>
                                    <input type="datetime-local" name="startDate" class="form-control rounded-3"
                                        id="startDate" />
                                        <div id="dateError" class="error-msg text-danger"></div>
                                </div>
                                <div class="col-12">
                                    <label for="subEndDate" class="form-label fw-semibold">End Date & Time</label>
                                    <input type="datetime-local" name="endDate" class="form-control rounded-3"
                                        id="endDate" />
                                        <div id="date1Error" class="error-msg text-danger"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 mt-3">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="reset" class="btn btn-outline-secondary rounded-3 px-4">Cancel</button>
                                <button type="submit" class="btn" style="background-color: #a05a3b; color: white;">Save
                                    Offer</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- EDIT SUBCATEGORY MODAL -->
            <div class="modal fade" id="editSubcategoryModal" tabindex="-1" aria-labelledby="editSubcategoryModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-md">
                    <form id="editSubcategoryForm" onsubmit="editSubcategory(event)" class="modal-content p-4 rounded-4 border-0"
                        enctype="multipart/form-data" method="POST" action="#">
                        <input type="hidden" id="edit-subcategory-id" name="subcategoryId" />
                        <div class="modal-header p-3 mb-3" style="background-color: #a05a3b; border-radius: 0.5rem;">
                            <h5 class="modal-title text-white fw-bold" id="editSubcategoryModalLabel">Edit Subcategory
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="edit-subcategory-name" class="form-label fw-semibold">Subcategory
                                        Name</label>
                                    <input type="text" name="subcategoryName" class="form-control rounded-3"
                                        id="edit-subcategory-name" />
                                    <div id="editSubNameError" class="error-msg"></div>
                                </div>
                                <div class="col-12">
                                    <label for="edit-subcategory-description"
                                        class="form-label fw-semibold">Description</label>
                                    <textarea name="description" class="form-control rounded-3"
                                        id="edit-subcategory-description" rows="3"></textarea>
                                    <div id="editSubDescriptionError" class="error-msg"></div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Current Image</label><br />
                                    <img id="existing-subcategory-image" src="" alt="Subcategory Image"
                                        style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px" />
                                </div>
                                <div class="col-12">
                                    <label for="edit-subcategory-image-upload" class="form-label fw-semibold">Change
                                        Image (optional)</label>
                                    <input type="file" name="subcategoryImage" id="edit-subcategory-image-upload"
                                        class="form-control rounded-3" accept="image/png, image/jpeg" />
                                    <div id="editSubImageError" class="error-msg"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 mt-3">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-outline-secondary rounded-3 px-4"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn"
                                    style="background-color: #a05a3b; color: white;">Update Subcategory</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-center mt-4">
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <% for(let i=1;i<=totalPages;i++){ %>
                            <li class="page-item <%= i==currentPage?'active':''%>">
                                <a class="page-link"
                                    href="/admin/subcategories/<%= category._id%>?page=<%= i%><%= search?'&search='+search:'' %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>
                    </ul>
                </nav>
            </div>
        </div>
    </main>
    <script>
        async function addSubcategory(e) {
            e.preventDefault()
            let form = document.getElementById('addSubcategoryForm')

            const formdata = new FormData(form)
            const subcategoryName = formdata.get('subcategoryName').trim()
            const subcategoryImage = formdata.get('subcategoryImage')
            const description = formdata.get('description').trim()
            const categoryId = formdata.get('categoryId')
            let hasError=false
            if (!subcategoryName) {
                document.getElementById('subNameError').textContent="subcategory name is required"
                hasError=true
            }
             if (!subcategoryImage || subcategoryImage.size === 0) {
                document.getElementById('subImageError').textContent="subcategory image is required"
                 hasError=true
            }
             if (!description) {
                document.getElementById('subDescriptionError').textContent="subcategory Description is required"
                 hasError=true
            }

            const allowedImageType = ['image/jpeg', 'image/png']
            if ((subcategoryImage)&&(!allowedImageType.includes(subcategoryImage.type))) {
                document.getElementById('subImageError').textContent="Only JPG or PNG files are allowed"
                hasError=true
            }

            if(hasError) return

            try {
                const response = await fetch('/admin/addSubcategory', {
                    method: 'POST',
                    body: formdata

                })

                const result = await response.json()
                if (result.success) {
                    Swal.fire({
                        icon: "success",
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    }).then(() => {
                        window.location.reload()
                    })
                } else {
                    Swal.fire({
                        icon: "error",
                        title: 'Error!',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    })
                }
            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: 'Error!',
                    text: 'Server error',
                    confirmButtonColor: '#dc3545'
                })
            }
        }

        //add offer
        function openAddSubOfferModal(id) {
            document.getElementById('subcategoryId').value = id
        }

        async function addSubcategoryOffer(e) {
            e.preventDefault()
            const form = document.getElementById('addSubOfferForm')
            const formdata = new FormData(form)
            const offerPercentage = formdata.get('offerPercentage')
            const startDate = formdata.get('startDate')
            const endDate = formdata.get('endDate')
            const subcategoryId = formdata.get('subcategoryId')
            const now = new Date()

             document.getElementById('offerError').textContent = "";
            document.getElementById('dateError').textContent = "";
            document.getElementById('date1Error').textContent = "";

            let hasError=false

            if (!offerPercentage) {
                document.getElementById('offerError').textContent = "Offer percentage is required";
                hasError = true;
            }
            if (!startDate) {
                document.getElementById('dateError').textContent = "Date is required";
                hasError = true;
            }
            if (!endDate) {
                document.getElementById('date1Error').textContent = "Date is required";
                hasError = true;
            }
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                document.getElementById('dateError').textContent = "Start date should be less than end date";
                hasError = true;
            }
            if (offerPercentage && (offerPercentage < 0 || offerPercentage > 100)) {
                document.getElementById('offerError').textContent = "Invalid offer Percentage";
                hasError = true;
            }

            if (hasError) return;


            try {
                const response = await fetch('/admin/addSubcategoryOffer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subcategoryId: subcategoryId,
                        offerPercentage: offerPercentage,
                        startDate,
                        endDate
                    })
                })

                const result = await response.json()
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#198754'
                    }).then(() => {
                        window.location.reload()
                    })
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    })
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Server Error',
                    text: "Something went wrong",
                    confirmButtonColor: '#dc3545'
                })
            }

        }
        //remove offer
        async function removeSubOffer(id) {
    const result = await Swal.fire({
        title: 'Are you sure?',
        text: "This will remove the offer!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Remove!'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch('/admin/removesubcatOffer', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Removed!',
                    text: data.message,
                    confirmButtonColor: '#198754'
                }).then(() => window.location.reload());
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Server Error',
                text: "Something went wrong",
                confirmButtonColor: '#dc3545'
            });
        }
    }
}

        //unlist subcategory
        function unlistSubcategory(subcategoryId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will unlist the subcategory!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Unlist!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/unlistSubcategory', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ subcategoryId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Unlisted!',
                                    'The Subcategory unlisted Succesfully.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    data.message || 'Failed to unlist.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'Something went wrong while unlisting the subcategory.',
                                'error'
                            );
                        });
                }
            });
        }

        //list subcategory
        function listSubcategory(subcategoryId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will list the subcategory!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Unlist!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/listSubcategory', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ subcategoryId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'listed!',
                                    'The Subcategory listed Succesfully.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    data.message || 'Failed to list.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'Something went wrong while listing the subcategory.',
                                'error'
                            );
                        });
                }
            });
        }
        //delete subcategory
        async function deleteSubcategory(id) {
    const result = await Swal.fire({
        title: 'Are you sure?',
        text: "This will delete subcategory!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Remove!'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch('/admin/deleteSubcategory', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subcategoryId: id })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: data.message,
                    confirmButtonColor: '#198754'
                }).then(() => window.location.reload());
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Server Error',
                text: "Something went wrong",
                confirmButtonColor: '#dc3545'
            });
        }
    }
}

        //edit subcategory
        function setEditmodal(id, subcategoryName, image, description) {
    document.getElementById('edit-subcategory-id').value = id
    document.getElementById('edit-subcategory-name').value = subcategoryName
    document.getElementById('edit-subcategory-description').value = description || ''
    document.getElementById('existing-subcategory-image').src = '/uploads/subcategory/' + image
}

        async function editSubcategory(e) {
            e.preventDefault();
            const form = document.getElementById('editSubcategoryForm')
            const formdata = new FormData(form)

            const subcategoryName = formdata.get('subcategoryName')
            const subcategoryImage = formdata.get('subcategoryImage')
            const description=formdata.get('description')
            const subcategoryId=formdata.get('subcategoryId')


            if (!subcategoryName.trim()) {
                Swal.fire({
                    icon: 'error',
                    title: 'Missing subcategory Name',
                    text: 'Please enter a subcategory name',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
             if (!description) {
                Swal.fire({
                    icon: 'error',
                    title: 'Description missing ',
                    text: 'Please add description',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }


            if (subcategoryImage && subcategoryImage.size > 0) {
                const allowedTypes = ["image/jpeg", "image/png"];
                if (!allowedTypes.includes(subcategoryImage.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File Type',
                        text: 'Only JPG or PNG images are allowed.',
                        confirmButtonColor: '#dc3545'
                    });
                    return;
                }
            }

            try {
                const response = await fetch('/admin/editSubcategory', {
                    method: 'PATCH',
                    body: formdata
                })
                const result = await response.json()
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#198754'
                    }).then(() => {
                        window.location.reload()
                    })
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    })
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Server Error',
                    text: "Something went wrong",
                    confirmButtonColor: '#dc3545'
                })
            }
        }

    </script>
    <!-- Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>