<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">


<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #fdf6f0;
    color: #1f1f1f;
    font-size: 0.9rem;
  }

  h1, h2, h3 { font-family: 'Playfair Display', serif; }
  h2 { font-size: 1.5rem; }
  h4 { font-size: 1.2rem; }
  h5 { font-size: 1rem; }

  .breadcrumb a, .breadcrumb-item.active { color: #6c757d; }

  /* --- Gallery Styles --- */
  .main-image-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 450px;
  }
  .main-image {
    width: 80%;
    height: 450px;
    object-fit: cover;
    border-radius: 6px;
  }

  /* --- Zoom Effect --- */
  .zoom-container {
    position: relative;
    overflow: hidden;
    height: 450px;
    border-radius: 6px;
  }
  .zoom-image {
    width: 80%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
    transform-origin: center center;
    will-change: transform;
  }
  .zoom-container:hover .zoom-image { transform: scale(2); }

  .thumbnail img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid transparent;
  }
  .thumbnail img.selected-thumb { border: 2px solid #000; }

  .arrow-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding: 10px 15px;
    background: rgba(150, 141, 141, 0.5);
    color: #fff;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    user-select: none;
    z-index: 10;
  }
  .arrow-left { left: 0.5px; }
  .arrow-right { right: 5px; }

  .color-swatch {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
    cursor: pointer;
    border: 1px solid #ccc;
  }
  .color-swatch.selected { border: 2px solid #000; }

  .btn-zyra { border-radius: 25px; padding: 8px 20px; font-weight: 600; font-size: 0.85rem; }
  .btn-wishlist, .btn-cart { background-color: #bd5555 !important; color: #fff; }

  .product-description { line-height: 1.5; font-size: 0.9rem; }

  .also-like .product-card-like {
    background-color: #fff;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }
  .also-like .product-card-like:hover { transform: translateY(-5px); }
  .also-like img { border-radius: 8px; max-height: 180px; object-fit: cover; }

  .size-btn, #qtyMinus, #qtyPlus { font-size: 0.8rem; padding: 5px 12px; }


</style>

<body>
  <%- include("../../views/partials/user/header") %>
  <div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/home">Home</a></li>
        <li class="breadcrumb-item"><a href="/shop">All Products</a></li>
        <li class="breadcrumb-item active" aria-current="page"><%= product.name %></li>
      </ol>
    </nav>

    <div class="row align-items-start">
      <!-- LEFT SIDE: PRODUCT GALLERY -->
      <div class="col-lg-6 col-md-12 mb-4">
        <% let images = (defaultVariant && defaultVariant.images && defaultVariant.images.length > 0)
              ? defaultVariant.images
              : []; %>

        <% if (images.length > 0) { %>
        <div class="d-flex">
          <!-- Thumbnails -->
          <div class="me-3" id="thumbnailContainer">
            <% images.forEach((img, index) => { %>
              <div class="thumbnail mb-2">
                <img src="/uploads/variants/<%= img %>" data-index="<%= index %>"
                     class="<%= index === 0 ? 'selected-thumb' : '' %>">
              </div>
            <% }) %>
          </div>

          <!-- Main Image + Arrows -->
          <div class="flex-grow-1 main-image-container zoom-container">
  <img src="/uploads/variants/<%= images[0] %>" id="mainImage" class="main-image zoom-image shadow">
  <span class="arrow-btn arrow-left" id="prevImg">‹</span>
  <span class="arrow-btn arrow-right" id="nextImg">›</span>
</div>
        </div>
        <% } else { %>
          <p>No images available</p>
        <% } %>
      </div>

      <!-- RIGHT SIDE: Product Details -->
      <div class="col-lg-6 col-md-12">
        <h2 class="mb-2"><%= product.name %></h2>
        <h5 class="text-decoration-line-through text-muted">₹<%= product.price %></h5>
        <h4 class="text-dark fw-bold" id="offerPrice">₹<%= product.finalPriceDynamic%></h4>
        <% if (product.bestOffer && product.bestOffer > 0) { %>
          <span class="badge bg-danger me-2 ">
            <%= product.bestOffer %>% OFF
          </span>
        <% } %>

        <!-- Size Selection -->
        <div class="my-3">
          <label class="form-label fw-bold">Select a size:</label>
          <div id="sizeOptions">
            <% availableSizes.forEach(size => { %>
              <button class="btn btn-outline-dark btn-sm me-2 mb-2 size-btn" data-size="<%= size %>"><%= size %></button>
            <% }) %>
          </div>
          <p id="sizeError" class="text-danger small"></p>
        </div>

        <!-- Color Selection -->
        <div class="my-3">
          <label class="form-label fw-bold">Color:</label>
          <div id="colorOptions">
            <% availableColors.forEach(color => { %>
              <span class="color-swatch" style="background-color:<%= color %>;" data-color="<%= color %>"></span>
            <% }) %>
          </div>
          <p id="ColorError" class="text-danger small"></p>
        </div>

        <!-- Quantity -->
        <div class="my-3">
          <label class="form-label fw-bold">Quantity:</label>
          <div class="d-flex align-items-center" style="max-width: 140px;">
            <button class="btn btn-outline-dark btn-sm" id="qtyMinus">−</button>
            <input type="number" id="quantity" class="form-control mx-2 text-center" value="1" min="1" max="5" style="width: 60px;">
            <button class="btn btn-outline-dark btn-sm" id="qtyPlus">+</button>
          </div>
        </div>

        <!-- Buttons -->
        <div class="my-4">
          <button class="btn btn-zyra btn-wishlist me-3" onclick="addToWishlist('<%= product._id%>')">Add to Wishlist </button>
          <button class="btn btn-zyra btn-cart" onclick="addToCart('<%= product._id %>')">Add to Cart</button>
        </div>
      </div>
    </div>

    <!-- Description & Review -->
    <div class="row mt-4">
      <div class="col-12">
        <ul class="nav nav-tabs" id="productTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button">Description</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button">Review</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <div class="tab-pane fade show active product-description" id="desc">
            <%= product.description || "No description available." %>
          </div>
          <div class="tab-pane fade" id="review">
            <p>No reviews yet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- You May Also Like -->
    <div class="mt-5">
      <h4>You May Also Like</h4>
      <div class="row g-3 also-like">
        <% if (likeProducts && likeProducts.length > 0) { %>
          <% likeProducts.forEach(product => { %>
            <div class="col-6 col-md-3">
              <div class="product-card-like text-center p-3">
                <% if (product.variantImage) { %>
                  <img src="/uploads/variants/<%= product.variantImage %>" class="img-fluid rounded mb-2">
                <% } else { %>
                  <img src="https://via.placeholder.com/200x250" class="img-fluid rounded mb-2">
                <% } %>
                <p class="mt-2" style="font-size:0.85rem;">
                  <%= product.name %><br>₹<%= product.finalPriceDynamic || product.finalPrice %>
                </p>
                <a href="/product/<%= product._id %>" class="btn btn-sm btn-outline-dark">View</a>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-muted">No similar products found.</p>
        <% } %>
      </div>
    </div>
  </div>

  <%- include("../../views/partials/user/footer") %>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>

    const zoomContainer = document.querySelector('.zoom-container');
const zoomImage = document.querySelector('.zoom-image');

zoomContainer.addEventListener('mousemove', (e) => {
  const rect = zoomContainer.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width) * 100;
  const y = ((e.clientY - rect.top) / rect.height) * 100;
  zoomImage.style.transformOrigin = `${x}% ${y}%`;
});
    let currentIndex = 0;
    const images = <%- JSON.stringify(defaultVariant?.images || []) %>;
    const mainImage = document.getElementById("mainImage");

    // Image navigation
    function updateImage() {
      mainImage.src = `/uploads/variants/${images[currentIndex]}`;
      document.querySelectorAll(".thumbnail img").forEach((img, i) => {
        img.classList.toggle("selected-thumb", i === currentIndex);
      });
    }
    document.getElementById("nextImg").onclick = () => { currentIndex = (currentIndex + 1) % images.length; updateImage(); };
    document.getElementById("prevImg").onclick = () => { currentIndex = (currentIndex - 1 + images.length) % images.length; updateImage(); };
    document.querySelectorAll(".thumbnail img").forEach(img => {
      img.addEventListener("click", function () { currentIndex = Number(this.dataset.index); updateImage(); });
    });

    const variants = <%- JSON.stringify(variants) %>;
    const basePrice = <%= product.finalPriceDynamic || product.price %>;
    let selectedSize = null;
    let selectedColor = null;

    // Size selection
    document.querySelectorAll('.size-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedSize = btn.getAttribute('data-size');
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Update variant based on size + color
        updateVariant();
      });
    });

    // Color selection
    document.querySelectorAll('.color-swatch').forEach(colorEl => {
      colorEl.addEventListener('click', () => {
        selectedColor = colorEl.getAttribute('data-color');
        document.querySelectorAll('.color-swatch').forEach(c => c.classList.remove('selected'));
        colorEl.classList.add('selected');

        // Update variant based on color + size
        updateVariant();
      });
    });

    function updateVariant() {
      let variant = null;
      if (selectedSize && selectedColor) variant = variants.find(v => v.size === selectedSize && v.color === selectedColor);
      if (!variant && selectedSize) variant = variants.find(v => v.size === selectedSize);
      if (!variant && selectedColor) variant = variants.find(v => v.color === selectedColor);

      if (variant) {
        // Update main image
        if (variant.images && variant.images.length > 0) {
          mainImage.src = `/uploads/variants/${variant.images[0]}`;
          currentIndex = 0;

          // Update thumbnails
          const thumbContainer = document.getElementById('thumbnailContainer');
          thumbContainer.innerHTML = '';
          variant.images.forEach((img, index) => {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'thumbnail mb-2';
            const thumbImg = document.createElement('img');
            thumbImg.src = `/uploads/variants/${img}`;
            thumbImg.dataset.index = index;
            if (index === 0) thumbImg.classList.add('selected-thumb');
            thumbImg.addEventListener('click', () => {
              currentIndex = index;
              mainImage.src = `/uploads/variants/${variant.images[index]}`;
              document.querySelectorAll('.thumbnail img').forEach(t => t.classList.remove('selected-thumb'));
              thumbImg.classList.add('selected-thumb');
            });
            thumbDiv.appendChild(thumbImg);
            thumbContainer.appendChild(thumbDiv);
          });
        }

        // Update price
        document.getElementById('offerPrice').textContent = "₹" + (variant.price || basePrice);
      }
    }

    // Quantity buttons
    const qtyInput = document.getElementById("quantity");
    const qtyMinus = document.getElementById("qtyMinus");
    const qtyPlus = document.getElementById("qtyPlus");

    qtyMinus.addEventListener("click", () => {
      let value = parseInt(qtyInput.value);
      if (value > 1) qtyInput.value = value - 1;
    });

    qtyPlus.addEventListener("click", () => {
      let value = parseInt(qtyInput.value);
      if (value < 5) qtyInput.value = value + 1;
    });

    // Add to cart
    async function addToCart(id) {
      let hasError = false;
      if (!selectedSize) { document.getElementById('sizeError').innerText = 'Select size'; hasError = true; }
      if (!selectedColor) { document.getElementById('ColorError').innerText = 'Select color'; hasError = true; }
      const quantity = document.getElementById('quantity').value;
      if (hasError) return;

      try {
        const response = await fetch('/cart/addProduct', {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: id, size: selectedSize, color: selectedColor, quantity })
        });
        const result = await response.json();
        if (result.success) {
          Swal.fire({ icon: 'success', title: 'Success!', text: result.message }).then(() => { window.location.reload(); });
        } else {
          Swal.fire({ icon: 'error', title: 'Error', text: result.message });
        }
      } catch (error) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Something went wrong' });
      }
    }


    async function addToWishlist(productId){
      let hasError=false
      
      
      if (!selectedColor) { document.getElementById('ColorError').innerText = 'Select color'; hasError = true; }
      const color=selectedColor
      if (hasError) return;
      try{
        const response=await fetch(`/wishlist/toggle`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({productId,color})
      })

      const result=await response.json()

      if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: result.message,
                confirmButtonColor: '#198754'
            })
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: result.message,
                confirmButtonColor: '#dc3545'
            });
        }
      }catch(error){
        Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Something went wrong',
            confirmButtonColor: '#dc3545'
        });
      }


    }
  </script>
</body>
</html>
