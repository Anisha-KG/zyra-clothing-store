<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<%- include("../../views/partials/user/header") %>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #fdf6f0;
    color: #1f1f1f;
  }
  h1, h2, h3 {
    font-family: 'Playfair Display', serif;
  }
  .product-images img {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 8px;
  }
  .color-swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
    cursor: pointer;
    border: 1px solid #ccc;
  }
  .color-swatch.selected {
    border: 2px solid #000;
  }
  .btn-zyra {
    border-radius: 30px;
    padding: 10px 25px;
    font-weight: 600;
  }
  .btn-wishlist {
    background-color: #c77c59;
    color: #fff;
  }
  .btn-cart {
    background-color: #000;
    color: #fff;
  }
  .product-description {
    line-height: 1.6;
    font-size: 0.95rem;
  }
  .also-like img {
    border-radius: 5px;
  }
  @media (max-width: 768px) {
    .color-swatch {
      width: 25px;
      height: 25px;
    }
  }
</style>
</head>

<body>
  <div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/home">Home</a></li>
        <li class="breadcrumb-item"><a href="/shop">All Products</a></li>
        <li class="breadcrumb-item active" aria-current="page"><%= product.name %></li>
      </ol>
    </nav>

    <!-- Product Section -->
    <div class="row align-items-start">
      <!-- LEFT SIDE: Product Images -->
      <div class="col-lg-6 col-md-12 product-images mb-4">
        <div class="row g-3">
          <% if (defaultVariant && defaultVariant.images && defaultVariant.images.length > 0) { %>
            <% defaultVariant.images.forEach((img) => { %>
              <div class="col-6">
                <img src="/uploads/variants/<%= img %>" alt="Product Image" class="img-fluid shadow-sm">
              </div>
            <% }) %>
          <% } else { %>
            <p>No images available</p>
          <% } %>
        </div>
      </div>

      <!-- RIGHT SIDE: Product Details -->
      <div class="col-lg-6 col-md-12">
        <h2 class="mb-2"><%= product.name %></h2>
        <p class="text-muted">HSN: <%= product.hsn || "N/A" %></p>

        <h5 class="text-decoration-line-through text-muted">₹<%= product.price %></h5>
        <h4 class="text-danger fw-bold" id="offerPrice">
          Offer Price: ₹<%= product.finalPrice || product.price %>
        </h4>

        <!-- Size Selection -->
        <div class="my-3">
          <label class="form-label fw-bold">Select a size:</label>
          <div id="sizeOptions">
            <% availableSizes.forEach(size => { %>
              <button class="btn btn-outline-dark btn-sm me-2 mb-2 size-btn" data-size="<%= size %>"><%= size %></button>
            <% }) %>
          </div>
          <p id="sizeError" class="text-danger small"></p>
        </div>

        <!-- Color Selection -->
        <div class="my-3">
          <label class="form-label fw-bold">Color:</label>
          <div id="colorOptions">
            <% availableColors.forEach(color => { %>
              <span class="color-swatch" 
                    style="background-color:<%= color %>;" 
                    data-color="<%= color %>" 
                    title="<%= color %>"></span>
            <% }) %>
          </div>
          <p id="ColorError" class="text-danger small"></p>
        </div>

        <!-- Quantity Selection -->
<div class="my-3">
  <label class="form-label fw-bold">Quantity:</label>
  <div class="d-flex align-items-center" style="max-width: 140px;">
    <button class="btn btn-outline-dark btn-sm" id="qtyMinus">−</button>
    <input type="number" id="quantity" class="form-control mx-2 text-center" value="1" min="1" max="5" style="width: 60px;">
    <button class="btn btn-outline-dark btn-sm" id="qtyPlus">+</button>
  </div>
</div>

        <!-- Buttons -->
        <div class="my-4">
          <button class="btn btn-zyra btn-wishlist me-3">Add to Wishlist</button>
          <button class="btn btn-zyra btn-cart" onclick="addToCart('<%= product._id%>')">Add to Cart</button>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="productTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Description</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">Review</button>
          </li>
        </ul>

        <div class="tab-content mt-3">
          <div class="tab-pane fade show active product-description" id="desc" role="tabpanel">
            <%= product.description || "No description available." %>
          </div>
          <div class="tab-pane fade" id="review" role="tabpanel">
            <p>No reviews yet.</p>
          </div>
        </div>
      </div>
    </div>
<!-- You May Also Like -->
<div class="mt-5">
  <h4>You May Also Like</h4>
  <div class="row g-3 also-like">
    <% if (likeProducts && likeProducts.length > 0) { %>
      <% likeProducts.forEach(product => { %>
        <div class="col-6 col-md-3 text-center">
          <!-- Product Image -->
          <% if (product.variantImage) { %>
            <img src="/uploads/variants/<%= product.variantImage %>" 
                 alt="<%= product.name %>" 
                 class="img-fluid rounded">
          <% } else { %>
            <img src="https://via.placeholder.com/200x250" alt="No Image" class="img-fluid rounded">
          <% } %>

          <!-- Product Info -->
          <p class="mt-2">
            <%= product.name %><br>
            <%= product.variantColor || '' %><br>
            ₹<%= product.price %>
          </p>

          <!-- View Product Button -->
          <a href="/product/<%= product._id %>" class="btn btn-sm btn-outline-dark">View</a>
        </div>
      <% }) %>
    <% } else { %>
      <p class="text-muted">No similar products found.</p>
    <% } %>
  </div>
</div>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const variants = <%- JSON.stringify(variants) %>;
    const basePrice = <%= product.finalPrice || product.price %>;
    
    let selectedSize = null;
    let selectedColor = null;

    const updateProductView = (variant) => {
      const imageContainer = document.querySelector('.product-images .row');
      imageContainer.innerHTML = variant.images.map(img =>
        `<div class="col-6"><img src="/uploads/variants/${img}" class="img-fluid shadow-sm"></div>`
      ).join('');

      // Always use base product price (since variants don’t have prices)
      document.getElementById('offerPrice').textContent = "Offer Price: ₹" + basePrice;
    };

    const findVariant = () => {
      let variant = null;

      if (selectedSize && selectedColor) {
        variant = variants.find(v => v.size === selectedSize && v.color === selectedColor);
      }
      if (!variant && selectedSize) {
        variant = variants.find(v => v.size === selectedSize);
      }
      if (!variant && selectedColor) {
        variant = variants.find(v => v.color === selectedColor);
      }

      if (variant) {
        updateProductView(variant);
      }
    };

    // Size selection
    document.querySelectorAll('.size-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedSize = btn.getAttribute('data-size');
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        findVariant();
      });
    });

    // Color selection
    document.querySelectorAll('.color-swatch').forEach(colorEl => {
      colorEl.addEventListener('click', () => {
        selectedColor = colorEl.getAttribute('data-color');
        document.querySelectorAll('.color-swatch').forEach(c => c.classList.remove('selected'));
        colorEl.classList.add('selected');
        findVariant();
      });
    });
     const qtyInput = document.getElementById("quantity");
  const qtyMinus = document.getElementById("qtyMinus");
  const qtyPlus = document.getElementById("qtyPlus");

  qtyMinus.addEventListener("click", () => {
    let value = parseInt(qtyInput.value);
    if (value > 1) qtyInput.value = value - 1;
  });

  qtyPlus.addEventListener("click", () => {
    let value = parseInt(qtyInput.value);
    if (value < 5) qtyInput.value = value + 1;
  });

async function addToCart(id) {
  let hasError = false;

  if (!selectedSize) {
    document.getElementById('sizeError').innerText = 'Select size';
    hasError = true;
  }

  if (!selectedColor) {
    document.getElementById('ColorError').innerText = 'Select color';
    hasError = true;
  }

  const productId = id;

  

  const quantity = document.getElementById('quantity').value; // FIXED

  if (hasError) return;

  try {
    const response = await fetch('/cart/addProduct', {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        productId,
         
        size: selectedSize,              
        color: selectedColor,             
        quantity
      })
    });

    const result = await response.json();

    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: result.message,
      }).then(() => {
        window.location.reload();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: result.message,
      });
    }

  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Something went wrong'
    });
  }
}

    
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
