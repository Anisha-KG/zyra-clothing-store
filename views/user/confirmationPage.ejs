<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zyra - Review Your Order</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background: #f8f5f4 !important; font-family: 'Poppins', sans-serif; font-size: 13px; }
    .review-container { padding: 20px 0; }
    .section-box { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 0 8px rgba(0,0,0,0.07); font-size: 0.9rem; }
    .product-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px dashed #ddd; }
    .product-row img { width: 60px; height: 80px; object-fit: cover; border-radius: 6px; }
    .total-box { background: #eee8e3; padding: 15px; border-radius: 10px; border: 1px solid #d9e6ff; font-size: 0.9rem; }
    .place-btn, .cancel-btn { width: 100%; padding: 10px; border-radius: 6px; font-weight: 600; font-size: 0.9rem; text-align: center; display: block; }
    .place-btn { background: black; color: white; border: none; }
    .place-btn:hover { background: #333; }
    .cancel-btn { background: #fff; color: #000; border: 1px solid #000; text-decoration: none; }
    .cancel-btn:hover { background: #f1f1f1; text-decoration: none; }
    .coupon-card {
  border: 1px solid #dcdcdc;
  background: #fafafa;
  padding: 14px 18px;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.2s ease;
}

.coupon-card:hover {
  background: #f0f0f0;
}

.coupon-card.reward {
  border-color: #1976d2;
  background: #e8f1ff;
}

.coupon-card h6 {
  margin-bottom: 4px;
}

.coupon-card .desc {
  margin-top: 4px;
}

.disabled-coupon {
    background-color: #e0e0e0 !important;
    color: #777 !important;
    pointer-events: none;
    opacity: 0.6;
    cursor: not-allowed;
}

  </style>
</head>
<body>

<!-- HEADER -->
<%- include("../../views/partials/user/header") %>

<div class="container review-container">
  <div class="row">

    <!-- LEFT SIDE: Address & Payment -->
    <div class="col-lg-6 mb-3">
      <div class="section-box">
        <h5 class="fw-bold mb-3">Delivery Address</h5>
        <p class="mb-1 fw-semibold"><%= address.name %></p>
        <p class="mb-1 text-muted"><%= address.addressName %>, <%= address.street %></p>
        <% if(address.landmark){ %>
        <p class="mb-1 text-muted"><%= address.landmark %></p>
        <% } %>
        <p class="mb-1 text-muted"><%= address.city %>, <%= address.state %> - <%= address.pincode %></p>
        <p class="mb-0 text-muted">Phone: <%= address.phone %></p>
        <p class="mb-0 text-muted">Phone: <%= address.altphone %></p>

        <hr class="my-3">

        <h5 class="fw-bold mb-2">Payment Method</h5>
        <p class="mb-0 fw-semibold"><%= paymentMethod.toUpperCase() %></p>
      </div>

       <!-- ========================= -->
<!-- COUPON SECTION -->
<!-- ========================= -->
<div class="section-box mt-3">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="fw-bold">Have a Coupon?</h5>
    <a href="#" data-bs-toggle="modal" data-bs-target="#couponModal">view coupons</a>
  </div>

  <div class="input-group">
    
    <% if (appliedCoupon) { %>
  <input type="text" id="couponInput" class="form-control" value="<%= appliedCoupon.code %>">
<% } else { %>
  <input type="text" id="couponInput" class="form-control" placeholder="Enter Code" value="">
<% } %>
    <input type="hidden" id="couponIdInput">   <!-- HIDDEN INPUT ADDED -->

    <button class="btn btn-dark" id="applyCouponBtn" onclick="applyCoupon()">
      Apply
    </button>
  </div>

</div>
<% if (typeof couponError !== 'undefined') { %>
  <div class="alert alert-danger"><%= couponError %></div>
<% } %>
    </div>

   



    <!-- RIGHT SIDE: Order Items -->
    <div class="col-lg-6 mb-3">
      <div class="section-box">
        <h5 class="fw-bold mb-3">Order Items • <%= cart.items.length %> products</h5>

        <% cart.items.forEach(item => { %>
          <div class="product-row">
            <img src="/uploads/variants/<%= item.variantId.images?.length ? item.variantId.images[0] : 'placeholder.png' %>" alt="Product Image">
            <div style="flex:1;">
              <div class="fw-semibold"><%= item.productId.name %></div>
              <div class="text-muted small">Size: <%= item.variantId.size %> | Color: <%= item.variantId.color %></div>
              <div class="text-muted small">Qty: <%= item.quantity %></div>
            </div>
            <div class="text-end">
              <div class="text-muted text-decoration-line-through">₹<%= item.productId.price * item.quantity %></div>
              <div class="fw-bold">₹<%= item.productId.finalPrice * item.quantity %></div>
            </div>
          </div>
        <% }) %>

      </div>
    </div>

  </div>

  <!-- TOTAL SECTION -->
  <div class="row mt-3">
    <div class="col-12">
      <div class="total-box">
        <div class="d-flex justify-content-between mb-2">
          <span>Total MRP</span>
          <span>₹<%= totalMRP %></span>
        </div>
        <div class="d-flex justify-content-between mb-2 text-success fw-bold">
          <span>Applicable Discount</span>
          <span>- ₹<%= applicableDiscount %></span>
        </div>
        <% if (appliedCoupon) { %>
  <div class="d-flex justify-content-between text-success fw-bold mb-2">
    <span>
  Coupon Discount 
  <button 
    class="btn btn-outline-danger btn-sm ms-2"
    onclick="window.location.href='/checkout/confirmationPage'">
    Remove
  </button>
</span>
    <span>
     -<%= appliedCoupon.discount %>
  </span>
  </div>
  <div class="d-flex justify-content-between text-primary mb-2">
    <span>Coupon Applied  </span>
    <span><%= appliedCoupon.code %></span>
  </div>
<% } %>
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal</span>
          <span>₹<%= subTotal %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Total Tax</span>
          <span>₹<%= totalTax %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>CGST (9%)</span>
          <span>₹<%= CGST %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>SGST (9%)</span>
          <span>₹<%= SGST %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Shipping Charge</span>
          <span><%= shippingCharge > 0 ? '₹' + shippingCharge : 'Free' %></span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold fs-5">
          <span>Total Payable</span>
          <span>₹<%= TotalPayable + shippingCharge %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="row mt-3 g-3">
    <div class="col-lg-6">
      <form action="/checkout/placeOrder" id="confirmOrder" method="POST">
        <button class="place-btn" type="submit">Confirm Order</button>
      </form>
    </div>
    <div class="col-lg-6">
      <a href="/cart" class="cancel-btn">Cancel</a>
    </div>
  </div>
</div>


<!-- ========================= -->
<!-- COUPON LIST MODAL (NEW) -->
<!-- ========================= -->
<div class="modal fade" id="couponModal" tabindex="-1">
  <div class="modal-dialog modal-lg">   <!-- smaller width -->
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold">Available Coupons</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-3">

        <div class="row g-3">

          <!-- LEFT SIDE — ALL COUPONS -->
          <div class="col-md-6 border-end pe-3" style="max-height: 70vh; overflow-y: auto;">

  <% coupons.forEach(coupon => { 
       const isDisabled = coupon.minimumOrderAmount > subTotal; // CHECK CONDITION
  %>

  <div class="coupon-card mb-3 
              <%= isDisabled ? 'disabled-coupon' : '' %>"
       onclick="<%= isDisabled ? '' : `selectCoupon('${coupon.code}', '${coupon._id}')` %>">

    <div class="d-flex justify-content-between">
      <h6 class="fw-bold"><%= coupon.code %></h6>
      <span class="fw-bold">
        <%= coupon.couponType === 'percentage'
            ? coupon.discountValue + '%' 
            : '₹' + coupon.discountValue %>
      </span>
    </div>

    <p class="small mb-1">Minimum Order: ₹<%= coupon.minimumOrderAmount %></p>
    <p class="small mb-1">Expires: <%= coupon.expiryDate.toLocaleDateString() %></p>
    <p class="desc small text-muted"><%= coupon.description %></p>

  </div>

  <% }) %>

</div>


          <!-- RIGHT SIDE — REWARD COUPONS -->
          <div class="col-md-6 ps-3" style="max-height: 70vh; overflow-y: auto;">

            <h6 class="fw-bold mb-2">Reward Coupons</h6>

            <% if (rewardCoupons.length === 0) { %>
              <p class="text-muted small">No reward coupons available.</p>
            <% } %>

            <% rewardCoupons.forEach(rc => { %>
            <div class="coupon-card reward mb-3" onclick="selectCoupon('<%= rc.couponCode %>', '<%= rc._id %>')">

              <div class="d-flex justify-content-between">
                <h6 class="fw-bold text-primary"><%= rc.couponCode %></h6>
                <span class="fw-bold text-primary">₹<%= rc.discount %></span>
              </div>

              <p class="small text-muted mb-0">Exclusive reward coupon for you.</p>

            </div>
            <% }) %>

          </div>

        </div>

      </div>

    </div>
  </div>
</div>


<%- include("../../views/partials/user/footer") %>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
 
<script>
  document.getElementById('confirmOrder').addEventListener('submit', async function (e) {
    e.preventDefault();

    try {
        const response = await fetch('/checkout/placeOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-requested-with': 'fetch'
            }
        });

        const result = await response.json();

        if (result.success) {

           if (result.paymentType === "razorpay") {
                // Razorpay → redirect to online payment page
                window.location.href = result.redirectUrl;
                return;
            }
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: result.message,
                confirmButtonColor: '#198754'
            }).then(() => window.location.href = '/orderSuccessfull');
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: result.message,
                confirmButtonColor: '#dc3545'
            }).then(() => window.location.href = '/getCart');
        }

    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Something went wrong',
            confirmButtonColor: '#dc3545'
        });
    }
});

 function selectCoupon(code, id) {
    // put values in inputs
    document.getElementById("couponInput").value = code;
    document.getElementById("couponIdInput").value = id;

    // close modal
    const modalElement = document.getElementById('couponModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();

    // FIX BACKDROP BUG
    setTimeout(() => {
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('padding-right');
    }, 200);
  }

async function applyCoupon() {
  const couponId = document.getElementById("couponIdInput").value;
  window.location.href=`/checkout/confirmationPage?couponId=${couponId}`
}

</script>
</html>
