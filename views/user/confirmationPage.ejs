<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zyra - Review Your Order</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background: #f8f5f4 !important; font-family: 'Poppins', sans-serif; font-size: 13px; }
    .review-container { padding: 20px 0; }
    .section-box { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 0 8px rgba(0,0,0,0.07); font-size: 0.9rem; }
    .product-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px dashed #ddd; }
    .product-row img { width: 60px; height: 80px; object-fit: cover; border-radius: 6px; }
    .total-box { background: #eee8e3; padding: 15px; border-radius: 10px; border: 1px solid #d9e6ff; font-size: 0.9rem; }
    .place-btn, .cancel-btn { width: 100%; padding: 10px; border-radius: 6px; font-weight: 600; font-size: 0.9rem; text-align: center; display: block; }
    .place-btn { background: black; color: white; border: none; }
    .place-btn:hover { background: #333; }
    .cancel-btn { background: #fff; color: #000; border: 1px solid #000; text-decoration: none; }
    .cancel-btn:hover { background: #f1f1f1; text-decoration: none; }
  </style>
</head>
<body>

<!-- HEADER -->
<%- include("../../views/partials/user/header") %>

<div class="container review-container">
  <div class="row">

    <!-- LEFT SIDE: Address & Payment -->
    <div class="col-lg-6 mb-3">
      <div class="section-box">
        <h5 class="fw-bold mb-3">Delivery Address</h5>
        <p class="mb-1 fw-semibold"><%= address.name %></p>
        <p class="mb-1 text-muted"><%= address.addressName %>, <%= address.street %></p>
        <% if(address.landmark){ %>
        <p class="mb-1 text-muted"><%= address.landmark %></p>
        <% } %>
        <p class="mb-1 text-muted"><%= address.city %>, <%= address.state %> - <%= address.pincode %></p>
        <p class="mb-0 text-muted">Phone: <%= address.phone %></p>
        <p class="mb-0 text-muted">Phone: <%= address.altphone %></p>

        <hr class="my-3">

        <h5 class="fw-bold mb-2">Payment Method</h5>
        <p class="mb-0 fw-semibold"><%= paymentMethod.toUpperCase() %></p>
      </div>
    </div>

    <!-- RIGHT SIDE: Order Items -->
    <div class="col-lg-6 mb-3">
      <div class="section-box">
        <h5 class="fw-bold mb-3">Order Items • <%= cart.items.length %> products</h5>

        <% cart.items.forEach(item => { %>
          <div class="product-row">
            <img src="/uploads/variants/<%= item.variantId.images?.length ? item.variantId.images[0] : 'placeholder.png' %>" alt="Product Image">
            <div style="flex:1;">
              <div class="fw-semibold"><%= item.productId.name %></div>
              <div class="text-muted small">Size: <%= item.variantId.size %> | Color: <%= item.variantId.color %></div>
              <div class="text-muted small">Qty: <%= item.quantity %></div>
            </div>
            <div class="text-end">
              <div class="text-muted text-decoration-line-through">₹<%= item.productId.price * item.quantity %></div>
              <div class="fw-bold">₹<%= item.productId.finalPrice * item.quantity %></div>
            </div>
          </div>
        <% }) %>

      </div>
    </div>

  </div>

  <!-- TOTAL SECTION -->
  <div class="row mt-3">
    <div class="col-12">
      <div class="total-box">
        <div class="d-flex justify-content-between mb-2">
          <span>Total MRP</span>
          <span>₹<%= totalMRP %></span>
        </div>
        <div class="d-flex justify-content-between mb-2 text-success fw-bold">
          <span>Applicable Discount</span>
          <span>- ₹<%= applicableDiscount %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal</span>
          <span>₹<%= subTotal %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Total Tax</span>
          <span>₹<%= totalTax %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>CGST (9%)</span>
          <span>₹<%= CGST %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>SGST (9%)</span>
          <span>₹<%= SGST %></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Shipping Charge</span>
          <span><%= shippingCharge > 0 ? '₹' + shippingCharge : 'Free' %></span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold fs-5">
          <span>Total Payable</span>
          <span>₹<%= TotalPayable + shippingCharge %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="row mt-3 g-3">
    <div class="col-lg-6">
      <form action="/checkout/placeOrder" id="confirmOrder" method="POST">
        <button class="place-btn" type="submit">Confirm Order</button>
      </form>
    </div>
    <div class="col-lg-6">
      <a href="/cart" class="cancel-btn">Cancel</a>
    </div>
  </div>
</div>

<!-- FOOTER -->
<%- include("../../views/partials/user/footer") %>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

<script>
  document.getElementById('confirmOrder').addEventListener('submit',async function(e) {
        e.preventDefault();
    try{
      const response=await fetch('/checkout/placeOrder',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        
      })

      const result=await response.json()
      
    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: result.message,
        confirmButtonColor: '#198754'
      }).then(() => window.location.href='/orderSuccessfull');
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: result.message,
        confirmButtonColor: '#dc3545'
      });
    }

    }catch(error){
      Swal.fire({
      icon: 'error',
      title: 'Server Error',
      text: 'Something went wrong',
      confirmButtonColor: '#dc3545'
    });
    }
  })
</script>
</html>
