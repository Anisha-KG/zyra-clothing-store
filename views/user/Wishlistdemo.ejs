<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Wishlist</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <%- include("../../views/partials/user/header") %>

  <style>
    body {
      background-color: #fdf6f0;
    }

    .wishlist-card {
      border: none;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      transition: 0.3s ease;
    }

    .wishlist-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    }

    .wishlist-img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-bottom: 1px solid #eee;
    }

    .remove-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      background: white;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      cursor: pointer;
      z-index: 20;
      font-size: 12px;
    }

    .product-title {
      font-size: 15px;
      font-weight: 500;
      min-height: 34px;
      line-height: 17px;
      overflow: hidden;
    }

    .price-section {
      font-size: 16px;
      font-weight: 600;
    }

    .old-price {
      text-decoration: line-through;
      font-size: 12px;
      color: #777;
      margin-left: 4px;
    }

    .discount {
      font-size: 12px;
      color: #ff3f6c;
      margin-left: 4px;
    }

    .move-btn {
      width: 100%;
      border: 1px solid #912f2f;
      color: #912f2f;
      font-weight: 600;
      border-radius: 3px;
      padding: 6px;
      font-size: 13px;
    }

    .move-btn:hover {
      background: #912f2f;
      color: white;
    }

    /* Profile button styling */
    .profile-btn {
      border: 1px solid #912f2f;
      color: #912f2f;
      font-weight: 600;
      border-radius: 3px;
      padding: 6px 12px;
      transition: 0.2s;
    }

    .profile-btn:hover {
      background-color: #912f2f;
      color: white;
    }
  </style>
</head>
<body>

<div class="container py-4">

  <!-- Header: Profile button left, Wishlist + item count right -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="profile-btn" onclick="window.location.href='/profile'">Profile</button>

    <div class="text-end">
      <h6 class="fw-bold mb-0">My Wishlist <span class="text-secondary small">(<%= totalItems %> items)</span></h6>
    </div>
  </div>

  <div class="row g-3">

    <% if (wishlist && wishlist.products.length > 0) { %>

      <% wishlist.products.forEach(item => { %>

        <%

        const variant=item
        
        %>
       <div class="col-6 col-md-4 col-lg-3">

  <div class="wishlist-card position-relative"
       style="cursor:pointer;"
       onclick="window.location.href='/product/<%= item.productId?._id %>'">

    <!-- Remove Icon -->
    <span class="remove-icon" 
          onclick='event.stopPropagation(); removeWishlist("<%= item.productId?._id %>", "<%= item.variantId?._id %>")'>
      <i class="fa-solid fa-xmark"></i>
    </span>

    <!-- Product Image -->
    <img 
      src="/uploads/variants/<%= item.variantId?.images?.[0] %>" 
      alt="product image"
      class="wishlist-img"
    >

    <div class="p-2">
      
      <!-- Product Title -->
      <div class="product-title">
        <%= item.productId?.name %>
      </div>

      <!-- Price Section -->
      <div class="d-flex justify-content-between align-items-center mt-1">
        <span class="price-section">Rs.<%= item.productId?.finalPrice %></span>

        <% if (item.productId?.price) { %>
          <span class="old-price">Rs.<%= item.productId.price %></span>
        <% } %>
      </div>

      <% if (item.productId?.price?.discount) { %>
        <div class="discount">(<%= item.productId.discount %>% OFF)</div>
      <% } %>

      <!-- Move to Bag -->
      <button class="btn move-btn mt-2"
              onclick="event.stopPropagation(); moveToCart(
                  '<%= item.productId._id %>',
                  '<%= item.variantId.size %>',
                  '<%= item.variantId.color %>'
              )">
        MOVE TO CART
      </button>

    </div>
  </div>

</div>

      <% }) %>

    <% } else { %>

      <div class="text-center text-muted">
        <h6>No items in wishlist</h6>
      </div>

    <% } %>

  </div>

</div>
  <%- include("../../views/partials/user/footer") %>
</body>
</html>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

    
 

  

  async function moveToCart(id,selectedSize,selectedColor) {
      
 const quantity=1
      try {
        const response = await fetch('/cart/addProduct', {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: id, size: selectedSize, color: selectedColor, quantity })
        });
        const result = await response.json();
        if (result.success) {
          Swal.fire({ icon: 'success', title: 'Success!', text: result.message }).then(() => { window.location.reload(); });
        } else {
          Swal.fire({ icon: 'error', title: 'Error', text: result.message });
        }
      } catch (error) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Something went wrong' });
      }
    }


    
    async function removeWishlist(productId,variantId){
        
      
      try{
        const response=await fetch(`/wishlist/toggle`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({productId,variantId})
      })

      const result=await response.json()

      if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: result.message,
                confirmButtonColor: '#198754'
            })
        }else if(result.removed){
          Swal.fire({
                icon: 'warning',
                title: 'Removed!',
                text: result.message,
                confirmButtonColor: '#dc3545'
            }).then(()=>window.location.reload())
        }
        
        else {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: result.message,
                confirmButtonColor: '#dc3545'
            });
        }
      }catch(error){
        Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Something went wrong',
            confirmButtonColor: '#dc3545'
        });
      }


    }
</script>

</body>
</html>
