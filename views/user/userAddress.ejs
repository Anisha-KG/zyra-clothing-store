<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zyra - My Addresses</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
     body { background: #f1e7e0 !important; font-family: 'Poppins', sans-serif; font-size: 13px; }

    .profile-card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      padding: 40px;
    }

    .address-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 1px solid #000;
      padding-bottom: 10px;
    }

    .btn-add-address {
      background-color: #a05a3b;
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: 30px;
      font-size: 14px;
      transition: 0.3s;
    }

    .btn-add-address:hover {
      background-color: #944828;
    }

    .address-card {
      background: #f8f8f8;
      border-radius: 10px;
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border: 1px solid #ddd;
    }

    .address-details {
      flex: 1;
    }

    .address-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .address-text {
      font-size: 14px;
      color: #333;
    }

    .address-actions button {
      display: block;
      width: 85px;
      margin-bottom: 5px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      color: #333;
      transition: 0.3s;
    }

    .address-actions button:hover {
      background-color: #f1f1f1;
    }

    #addAddressForm {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-top: 30px;
    }

    #editAddressForm {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-top: 30px;
    }

    #addAddressForm input,
    #addAddressForm textarea,
    #addAddressForm select {
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #addAddressForm label {
      font-weight: 500;
      font-size: 14px;
    }

    #addAddressForm .btn-save {
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
    }

    #addAddressForm .btn-cancel {
      border: 1px solid #000;
      background: transparent;
      border-radius: 8px;
      padding: 8px 20px;
    }

    .text-danger {
      font-size: 13px;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <%- include("../../views/partials/user/header") %>

    <div class="container py-5">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 mb-4">
          <%- include("../../views/partials/user/userProfile-sidebar") %>
        </div>

        <!-- Address Section -->
        <div class="col-md-9">
          <!-- Address View -->
          <div id="viewAddress" class="profile-card">
            <div class="address-header">
              <h5 class="mb-0">MY ADDRESSES</h5>
              <button id="showAddForm" class="btn btn-add-address" onclick="showaddAddress()">+ Add Address</button>
            </div>

            <% if (addresses && addresses.length> 0) { %>
              <% addresses.forEach(function(addr){ %>
                <div class="address-card">
                  <div class="address-details">
                    <div class="address-name">
                      <%= addr.name %> (<%= addr.addressType %>)
                    </div>
                    <div class="address-text">
                      <%= addr.addressName%><br />
                        <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %><br />
                              <strong>Landmark:</strong>
                              <%= addr.landmark %><br />
                                <strong>Phone:</strong>
                                <%= addr.phone %>
                    </div>
                  </div>
                  <div class="address-actions">

                    <button id="showeditForm"
                      onclick="showeditAddress('<%= addr._id%>','<%= addr.name%>','<%= addr.phone%>','<%= addr.altphone%>','<%= addr.pincode%>','<%= addr.addressName%>','<%= addr.city%>','<%= addr.state%>','<%= addr.landmark%>','<%= addr.addressType%>',<%= addr.isDefault%>)">Edit</button>


                    <button id="deleteAddress" onclick="deleteAddress('<%= addr._id%>')">Delete</button>

                  </div>
                </div>
                <% }) %>
                  <% } else { %>
                    <p class="text-muted">No addresses added yet.</p>
                    <% } %>
          </div>

          <!-- Add Address Form -->
          <div id="addAddress" style="display: none;">
            <form id="addAddressForm">
              <h5 class="text-center mb-4 fw-bold">ADD NEW ADDRESS</h5>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Full Name</label>
                  <input type="text" name="name" class="form-control" placeholder="Enter your name" />
                  <small id="nameError" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                  <label>Phone Number</label>
                  <input type="text" name="phone" class="form-control" placeholder="Enter your phone number" />
                  <small id="phoneError" class="text-danger"></small>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Alternate Phone</label>
                  <input type="text" name="altphone" class="form-control"
                    placeholder="Alternate phone number (optional)" />
                  <small id="altphoneError" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                  <label>Pincode</label>
                  <input type="number" name="pincode" class="form-control" placeholder="Enter your pincode" />
                  <small id="pincodeError" class="text-danger"></small>
                </div>
              </div>

              <div class="mb-3">
                <label>Address</label>
                <textarea name="addressName" class="form-control" placeholder="House No, Street, Area"
                  rows="2"></textarea>
                <small id="addressError" class="text-danger"></small>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label>City</label>
                  <input type="text" name="city" class="form-control" placeholder="Enter your city" />
                  <small id="cityError" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                  <label>State</label>
                  <input type="text" name="state" class="form-control" placeholder="Enter your state" />
                  <small id="stateError" class="text-danger"></small>
                </div>
              </div>

              <div class="mb-3">
                <label>Landmark</label>
                <input type="text" name="landmark" class="form-control" placeholder="Enter landmark (optional)" />
              </div>
              <div class="mb-3 d-flex align-items-center justify-content-between">

                <!-- Left: Address Type -->
                <div class="d-flex align-items-center">
                  <label class="d-flex align-items-center mb-0 me-3">
                    <input type="radio" id="addressType" name="addressType" value="Home" checked class="me-1" />
                    Home
                  </label>

                  <label class="d-flex align-items-center mb-0">
                    <input type="radio" id="addressType" name="addressType" value="Work" class="me-1" />
                    Work
                  </label>
                </div>

                <!-- Right: Default Checkbox -->
                <label class="d-flex align-items-center mb-0 ms-4">
                  <input type="checkbox" name="isDefault" id="isDefault" class="me-2" />
                  Set as default
                </label>

              </div>

              <small id="addressTypeError" class="text-danger d-block"></small>
              <small id="isDefaultError" class="text-danger d-block"></small>


              <small id="addressTypeError" class="text-danger d-block"></small>
              <small id="isDefaultError" class="text-danger d-block"></small>


              <div class="text-center">
                <button type="submit" class="btn btn-save">Save</button>
                <button type="button" id="cancelAdd" class="btn btn-cancel ms-2"
                  onclick="canceladdAddress()">Cancel</button>
              </div>
            </form>
          </div>

          <!-- edit Address Form -->
          <div id="editAddress" style="display: none;">
            <form id="editAddressForm">
              <h5 class="text-center mb-4 fw-bold">EDIT ADDRESS</h5>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Full Name</label>
                  <input type="text" name="name" id="name" class="form-control" />
                  <input type="text" name="id" id="addressId" class="form-control" hidden />

                  <small id="nameError" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                  <label>Phone Number</label>
                  <input type="text" name="phone" id="phone" class="form-control"
                    placeholder="Enter your phone number" />
                  <small id="phoneError" class="text-danger"></small>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Alternate Phone</label>
                  <input type="text" name="altphone" id="altphone" class="form-control"
                    placeholder="Alternate phone number (optional)" />
                  <small id="altphoneError" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                  <label>Pincode</label>
                  <input type="number" name="pincode" id="pincode" class="form-control"
                    placeholder="Enter your pincode" />
                  <small id="pincodeError" class="text-danger"></small>
                </div>
              </div>

              <div class="mb-3">
                <label>Address</label>
                <textarea name="addressName" id="addressName" class="form-control" placeholder="House No, Street, Area"
                  rows="2"></textarea>
                <small id="addressError" class="text-danger"></small>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label>City</label>
                  <input type="text" name="city" id="city" class="form-control" placeholder="Enter your city" />
                  <small id="cityError" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                  <label>State</label>
                  <input type="text" name="state" id="state" class="form-control" placeholder="Enter your state" />
                  <small id="stateError" class="text-danger"></small>
                </div>
              </div>

              <div class="mb-3">
                <label>Landmark</label>
                <input type="text" name="landmark" id="landmark" class="form-control"
                  placeholder="Enter landmark (optional)" />
              </div>
 <div class="mb-3 d-flex align-items-center justify-content-between">

                <!-- Left: Address Type -->
                <div class="d-flex align-items-center">
                  <label class="d-flex align-items-center mb-0 me-3">
                    <input type="radio" id="home" name="addressType" value="Home" checked class="me-1" />
                    Home
                  </label>

                  <label class="d-flex align-items-center mb-0">
                    <input type="radio" id="work" name="addressType" value="Work" class="me-1" />
                    Work
                  </label>
                </div>

                <!-- Right: Default Checkbox -->
                <label class="d-flex align-items-center mb-0 ms-4">
                  <input type="checkbox" name="isDefault" id="editisDefault" class="me-2" />
                  Set as default
                </label>

              </div>

              <small id="addressTypeError" class="text-danger d-block"></small>
              <small id="isDefaultError" class="text-danger d-block"></small>


              <small id="addressTypeError" class="text-danger d-block"></small>
              <small id="isDefaultError" class="text-danger d-block"></small>


              <div class="text-center">
                <button type="submit" class="btn btn-save">Save</button>
                <button type="button" id="cancelAdd" class="btn btn-cancel ms-2"
                  onclick="canceleditAddress()">Cancel</button>
              </div>
            </form>

          </div>
        </div>
      </div>

<nav aria-label="Page navigation" class="mt-4">
  <ul class="pagination justify-content-center">
    
    <% if (page > 1) { %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= page - 1 %>">Prev</a>
      </li>
    <% } %>

    <% for(let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= page === i ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
      </li>
    <% } %>

    <% if (page < totalPages) { %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= page + 1 %>">Next</a>
      </li>
    <% } %>

  </ul>
</nav>




      <%- include("../../views/partials/user/footer") %>

      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      <script>
        history.scrollRestoration = "manual";

        window.addEventListener("load", () => {
          setTimeout(() => {
            window.scrollTo(0, 0);
          }, 50);
        });
        function showaddAddress() {
          document.getElementById("viewAddress").style.display = "none";
          document.getElementById("addAddress").style.display = "block";
        }

        function canceladdAddress() {
          document.getElementById("addAddress").style.display = "none";
          document.getElementById("viewAddress").style.display = "block";
        }

        function showeditAddress(id, name, phone, altphone, pincode, addressName, city, state, landmark, addressType,isDefault) {
          document.getElementById("viewAddress").style.display = "none";

          document.getElementById("editAddress").style.display = "block";

          document.getElementById('name').value = name
          document.getElementById('phone').value = phone
          document.getElementById('altphone').value = altphone
          document.getElementById('pincode').value = pincode
          document.getElementById('addressName').value = addressName
          document.getElementById('city').value = city
          document.getElementById('state').value = state
          document.getElementById('landmark').value = landmark
         
          document.getElementById('addressId').value = id

          document.getElementById("home").checked  = addressType === "Home";
          document.getElementById("work").checked  = addressType === "Work";
           document.getElementById("editisDefault").checked = isDefault === true;


        }

        function canceleditAddress() {
          document.getElementById("editAddress").style.display = "none";
          document.getElementById("viewAddress").style.display = "block";
        }

        document.getElementById('addAddressForm').addEventListener('submit', async function (e) {
          e.preventDefault();

          // clear old errors
          document.querySelectorAll('.text-danger').forEach(el => el.innerText = '');

          const form = e.target;
          const formData = new FormData(form);

          const name = formData.get('name');
          const phone = formData.get('phone');
          const altphone = formData.get('altphone');
          const addressName = formData.get('addressName');
          const pincode = formData.get('pincode');
          const city = formData.get('city');
          const state = formData.get('state');
          const addressType = formData.get('addressType');
          const isDefault = document.getElementById("isDefault").checked;
          formData.set("isDefault", isDefault);

          let hasError = false;
          const phonePattern = /^[0-9]{10}$/;
          const pincodePattern = /^[1-9][0-9]{5}$/;

          if (!name.trim()) {
            document.getElementById('nameError').innerText = 'Please enter your name';
            hasError = true;
          }

          if (!phone.trim()) {
            document.getElementById('phoneError').innerText = 'Please enter your phone number';
            hasError = true;
          } else if (!phonePattern.test(phone)) {
            document.getElementById('phoneError').innerText = 'Enter a valid 10-digit number';
            hasError = true;
          }



          if (!addressName.trim()) {
            document.getElementById('addressError').innerText = 'Please enter your address';
            hasError = true;
          }

          if (!pincode.trim()) {
            document.getElementById('pincodeError').innerText = 'Please enter pincode';
            hasError = true;
          } else if (!pincodePattern.test(pincode)) {
            document.getElementById('pincodeError').innerText = 'Enter a valid 6-digit pincode';
            hasError = true;
          }

          if (!city.trim()) {
            document.getElementById('cityError').innerText = 'Please enter city';
            hasError = true;
          }

          if (!state.trim()) {
            document.getElementById('stateError').innerText = 'Please enter state';
            hasError = true;
          }

          if (!addressType) {
            document.getElementById('addressTypeError').innerText = 'Please select address type';
            hasError = true;
          }

          if (hasError) return;

          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch('/addAddress', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: result.message,
                confirmButtonColor: '#198754'
              }).then(() => window.location.reload());
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: result.message,
                confirmButtonColor: '#dc3545'
              });
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Server Error',
              text: 'Something went wrong',
              confirmButtonColor: '#dc3545'
            });
          }
        });

        //edit address

        document.getElementById('editAddressForm').addEventListener('submit', async function (e) {
          e.preventDefault();

          // clear old errors
          document.querySelectorAll('.text-danger').forEach(el => el.innerText = '');

          const form = e.target;
          const formData = new FormData(form);

          const name = formData.get('name');
          const phone = formData.get('phone');
          const altphone = formData.get('altphone');
          const addressName = formData.get('addressName');
          const pincode = formData.get('pincode');
          const city = formData.get('city');
          const state = formData.get('state');
          const addressType = formData.get('addressType');
          const id = formData.get('id')
          const isDefault = document.getElementById("editisDefault").checked;
          formData.set("isDefault", isDefault);

          let hasError = false;
          const phonePattern = /^[0-9]{10}$/;
          const pincodePattern = /^[1-9][0-9]{5}$/;

          if (!name.trim()) {
            document.getElementById('nameError').innerText = 'Please enter your name';
            hasError = true;
          }

          if (!phone.trim()) {
            document.getElementById('phoneError').innerText = 'Please enter your phone number';
            hasError = true;
          } else if (!phonePattern.test(phone)) {
            document.getElementById('phoneError').innerText = 'Enter a valid 10-digit number';
            hasError = true;
          }



          if (!addressName.trim()) {
            document.getElementById('addressError').innerText = 'Please enter your address';
            hasError = true;
          }

          if (!pincode.trim()) {
            document.getElementById('pincodeError').innerText = 'Please enter pincode';
            hasError = true;
          } else if (!pincodePattern.test(pincode)) {
            document.getElementById('pincodeError').innerText = 'Enter a valid 6-digit pincode';
            hasError = true;
          }

          if (!city.trim()) {
            document.getElementById('cityError').innerText = 'Please enter city';
            hasError = true;
          }

          if (!state.trim()) {
            document.getElementById('stateError').innerText = 'Please enter state';
            hasError = true;
          }

          if (!addressType) {
            document.getElementById('addressTypeError').innerText = 'Please select address type';
            hasError = true;
          }

          if (hasError) return;

          const data = {
  ...Object.fromEntries(formData.entries()),
  isDefault: isDefault, // override unreliable FormData value
  id: document.getElementById("addressId").value
};

          try {
            const response = await fetch('/editAddress', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: result.message,
                confirmButtonColor: '#198754'
              }).then(() => window.location.reload());
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: result.message,
                confirmButtonColor: '#dc3545'
              });
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Server Error',
              text: 'Something went wrong',
              confirmButtonColor: '#dc3545'
            });
          }
        });


        //delete address

        async function deleteAddress(id) {
          try {
            const response = await fetch('/deleteAddress', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id })
            });

            const result = await response.json();

            if (result.success) {
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: result.message,
                confirmButtonColor: '#198754'
              }).then(() => window.location.reload());
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: result.message,
                confirmButtonColor: '#dc3545'
              });
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Server Error',
              text: 'Something went wrong',
              confirmButtonColor: '#dc3545'
            });
          }
        };



      </script>
</body>

</html>